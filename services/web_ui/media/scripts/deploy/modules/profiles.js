(function(a){function g(b){var c=0;for(var d=0;d<b.files.length;d++)a.inArray(b.files[d].fileName.substr(-4,4),b.formats)!=-1&&(c+=1);d=0,onload=b.onload,b.total=0,b.sent=0;while(b.current<c)b.total+=b.files[b.current++].fileSize;b.current=0;if(c){for(var d=0;d<b.files.length;d++)if(a.inArray(b.files[d].fileName.substr(-4,4),b.formats)!=-1){b.file=b.files[d],b.current=d;break}f(b).onload=function(d,e){if(++b.current<c){b.sent+=b.files[b.current-1].fileSize;for(var g=b.current;g<b.files.length;g++)if(a.inArray(b.files[g].fileName.substr(-4,4),b.formats)!=-1){b.file=b.files[g],b.current=g;break}f(b).onload=arguments.callee}else onload&&(b.onload=onload,b.onload(d,e))}}else{var e="";for(var d=0;d<b.formats;d++)d!=b.formats.length-1?e+=b.formats[d]+",":e+=b.formats[d];a.jGrowl("Only files with the following extensions are allowed:"+e)}return b}function e(a){var b=0;while(1023<a)a/=1024,++b;return b?a.toFixed(2)+[""," Kb"," Mb"," Gb"," Tb"][b]:a+" bytes"}var b=0,c={},d={init:function(d){var e={url:"",submit:"",cancel:"",select_box:"",formats:[],progress:""};c=a.extend(e,d),this.each(function(){var d=a(this).get(0);a(c.progress).html('<div id="upload-progressbar"></div><div id="upload-status-text"></div>'),a("#upload-progressbar").progressbar({value:0,disabled:!0}),a(this).change(function(){b=0;var d="",e=!1;if(this.files.length>0){for(var f=0;f<this.files.length;f++)a.inArray(this.files[f].fileName.substr(-4,4),c.formats)!=-1&&(b+=this.files[f].fileSize,d+="<p>"+this.files[f].fileName+"</p>",e=!0);if(e)a(c.submit).removeClass("ui-state-disabled");else{a(c.submit).addClass("ui-state-disabled");var g="";for(var f=0;f<c.formats.length;f++)f!=c.formats.length-1?g+=c.formats[f]+",":g+=c.formats[f];var h=gettext("Only files with the following extensions are allowed")+": "+g;a("#notify-container").notify("create","notify-info",{i18n:h})}}else a(c.submit).addClass("ui-state-disabled");a(c.select_box).html(d)})})},send:function(d){this.each(function(){var f=a(this).get(0);a(this).attr("disabled","true"),a(c.submit).addClass("ui-state-disabled"),a(c.cancel).addClass("ui-state-disabled");var h=a("#upload-status-text").get(0);g({url:c.url,formats:c.formats,files:f.files,onloadstart:function(){h.innerHTML="Init upload ... "},onprogress:function(c){total_progress=parseInt((this.sent+c.loaded)/b*100),file_progress=parseInt(c.loaded/c.total*100),a("#upload-progressbar").progressbar("option","value",total_progress),h.innerHTML=["Uploading: "+this.file.fileName+" ("+file_progress+"%)","Sent: "+e(this.sent+c.loaded)+" of "+e(b)].join("<br />")},onload:function(a,b){response=JSON.parse(b.responseText),d(response)},onerror:function(){h.innerHTML="The file "+this.file.fileName+" is too big ["+e(this.file.fileSize)+"]",f.removeAttribute("disabled")}})})}};a.fn.xhr_upload=function(b){if(d[b])return d[b].apply(this,Array.prototype.slice.call(arguments,1));if(typeof b!=="object"&&b)a.error("Method "+b+" does not exist on jQuery.xhr_upload");else return d.init.apply(this,arguments)};var f=1024e5;f=function(b,c){var d=function(a){return b.call(a)==="[object Function]"},e="onabort.onerror.onloadstart.onprogress".split("."),f=e.length;return function(b){if(c&&c<b.file.fileSize)d(b.onerror)&&b.onerror();else{var g=new XMLHttpRequest,h=g.upload;for(var g=new XMLHttpRequest,h=g.upload,i=0;i<f;i++)h[e[i]]=function(a){return function(c){d(b[a])&&b[a].call(b,c,g)}}(e[i]);h.onload=function(a){b.onreadystatechange===!1?d(b.onload)&&b.onload(a,g):setTimeout(function(){g.readyState===4?d(b.onload)&&b.onload(a,g):setTimeout(arguments.callee,15)},15)},a.inArray(b.file.fileName.substr(-4,4),b.formats)!=-1&&(g.open("POST",b.url),g.setRequestHeader("If-Modified-Since","Mon, 26 Jul 1997 05:00:00 GMT"),g.setRequestHeader("Cache-Control","no-cache"),g.setRequestHeader("X-Requested-With","XMLHttpRequest"),g.setRequestHeader("X-File-Name",b.file.fileName),g.setRequestHeader("X-File-Size",b.file.fileSize),g.setRequestHeader("Content-Type","application/octet-stream"),g.send(b.file));return b}}}(Object.prototype.toString,f)})(jQuery),define("lib/jquery/jquery.xhr_upload",function(){}),require.def("modules/profiles",["lib/jquery/jquery.xhr_upload"],function(){function h(){}function g(){}function f(){application.ws.method("^/profiles/manage/modified/$",function(a){application.functions.profiles.manage_profiles(a,!0)})}function e(){application.functions.profiles={route:function(a,b){c==undefined&&(c=[[XRegExp("^/data/profiles/login/$"),this.login],[XRegExp("^/data/profiles/logout/$"),this.logout],[XRegExp("^/data/profiles/register/$"),this.register],[XRegExp("^/profiles/activate/(?<profile_uuid>[^/]+)/$"),this.activate],[XRegExp("^/profiles/manage/$"),this.manage_profiles],[XRegExp("^/profiles/(?<profile_name>[^/]+)/$"),this.view_profile],[XRegExp("^/profiles/create/$"),this.create_profile],[XRegExp("^/profiles/(?<profile_name>[^/]+)/whois/$"),this.whois_profile],[XRegExp("^/profiles/(?<profile_name>[^/]+)/edit/$"),this.edit_profile]]),application.route_uri_to_mod_function(a,c,b)},view_profile:function(a,c){if(c==undefined)application.ws.remote("/profiles/"+a.profile_name+"/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main"));var c=$("#personal_tabs").tabs();c.tabs("option","selected",b)});else{application.functions.ui.transition(a.data.dom.main,$(".main"));var d=$("#personal_tabs").tabs();d.tabs("option","selected",b)}},manage_profiles:function(a,c){if(c==undefined)application.ws.remote("/profiles/manage/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main"));var c=$("#personal_tabs").tabs();c.tabs("option","selected",b)});else{application.functions.ui.transition(a.data.dom.main,$(".main"));var d=$("#personal_tabs").tabs();d.tabs("option","selected",b)}},register:function(){application.ws.remote("/data/profiles/register/",{},function(a){var b={};b[gettext("Cancel")]=function(){$(this).dialog("destroy"),c=undefined},b[gettext("Register")]=function(){$(".ui-dialog-buttonpane").find("button").hide(),$(c).find("input").attr("readonly",!0),c.dialog("option","title",'<span class="ui-icon ui-icon-person"></span><span>'+gettext("Registration pending")+"</span>");var a=$("form:visible").serializeObject();application.ws.remote("/data/profiles/register/",{params:a},function(a){switch(a.status.code){case"REGISTER_OK":$(".registerDialog > .ui-dialog-content").html(a.data.dom.dialog),c.dialog("option","title",'<span class="ui-icon ui-icon-person"></span><span>'+gettext("Registration completed")+"</span>");var b={};b[gettext("Close")]=function(){$(this).dialog("destroy"),c=undefined},c.dialog("option","buttons",b);break;case"FORM_INVALID":$(".ui-dialog-buttonpane").find("button").show(),$(c).find("input").attr("readonly",!1),c.dialog("option","title",'<span class="ui-icon ui-icon-person"></span><span>'+gettext("Register")+"</span>"),$(".registerDialog > .ui-dialog-content").html(a.data.dom.dialog),$.each($(".registerDialog .errorlist"),function(){$(this).next().prepend('<span class="ui-icon ui-icon-info"></span>')});break;default:}})};var c=$(a.data.dom.dialog).dialog({dialogClass:"registerDialog",autoOpen:!0,position:"center",width:450,title:'<span class="ui-icon ui-icon-pencil"></span><span>'+gettext("Register")+"</span>",resizable:!1,draggable:!0,modal:!0,buttons:b,open:function(a,b){var c=$(a.target).parents(".ui-dialog.ui-widget"),d=c.find(".ui-dialog-buttonpane").find("button"),e=d[0],f=d[1];$(e).addClass("dialog-button"),$(f).addClass("dialog-button")}})},"html")},activate:function(a){application.ws.remote("/profiles/activate/"+a.profile_uuid+"/",{},function(a){switch(a.status.code){case"PROFILE_ACTIVATED":var b={};b[gettext("Ok")]=function(){$(this).dialog("destroy"),$register=undefined,application.route_uri_to_mod("/",!0)};var c=$(a.data.dom.dialog).dialog({dialogClass:"activateDialog",autoOpen:!0,position:"center",width:450,title:'<span class="ui-icon ui-icon-person"></span><span>'+gettext("Your account has been activated!")+"</span>",resizable:!1,draggable:!0,modal:!0,buttons:b,zIndex:1e6,close:function(){application.route_uri_to_mod("/",!0)}});break;case"PROFILE_ALREADY_ACTIVATED":application.route_uri_to_mod("/",!0)}})},login:function(){application.ws.remote("/data/profiles/login/",{},function(a){var b={};b[gettext("Cancel")]=function(){$(this).dialog("close")},b[gettext("Login")]=function(){var a=$("form:visible").serialize();$.post("/data/profiles/login/",a,function(a){switch(a.status.code){case"FORM_INVALID":$(".loginDialog > .ui-dialog-content").html(a.data.dom.dialog),$.each($(".loginDialog .errorlist"),function(){$(this).next().prepend('<span class="ui-icon ui-icon-info"></span>')});break;case"CRED_OK":application.settings.user=a.data.user,$("#menu-container").html(a.data.dom.navbar),$(document).trigger("USER_LOGIN",[]),$login.dialog("close"),application.ws.close();break;default:$(".loginDialog > .ui-dialog-content").html(a.data.dom.dialog)}$("#notify-container").notify("create",application.ws.tt[a.status.type],{i18n:a.status.i18n})},"json")},$login=$(a.data.dom.dialog).dialog({dialogClass:"loginDialog",position:"center",width:450,title:'<span class="ui-icon ui-icon-person"></span><span>'+gettext("Login")+"</span>",resizable:!1,draggable:!0,modal:!0,buttons:b,autoOpen:!0})})},logout:function(){$.getJSON("/data/profiles/logout/",function(a){a.status.code=="LOGOUT_OK"?($("#menu-container").html(a.data.dom.navbar),application.settings.user=a.data.user,$(document).trigger("USER_LOGOUT",[]),application.ws.close()):console.log("An error occured"),$("#notify-container").notify("create","notify-info",{i18n:a.status.i18n})})},create_profile:function(){application.ws.remote("/profiles/create/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main"))})},save_create_profile:function(){var a=$("form:visible").serializeObject();application.ws.remote("/profiles/create/",{params:a},function(a){switch(a.status.code){case"PROFILE_CREATE_OK":application.functions.ui.transition(a.data.dom.main,$(".main")),$("#personal_tabs").tabs();break;case"FORM_INVALID":application.functions.ui.transition(a.data.dom.main,$(".main"),a.status.code),$.each($(".errorlist"),function(){$(this).next().prepend('<span class="ui-icon ui-icon-info"></span>')})}})},cancel_create_profiles:function(){this.manage_profiles()},delete_profiles:function(a){application.ws.remote("/data/profiles/delete/",{},function(a){var b={};b[gettext("Cancel")]=function(){$(this).dialog("close")},b[gettext("Delete")]=function(){var a={};$.each($(":checkbox:checked:visible"),function(b,c){a[$(this).data("uuid")]={first_name:$(this).data("first_name"),last_name:$(this).data("last_name")}}),application.ws.remote("/data/profiles/delete/",{params:a},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),c.dialog("destroy"),c=undefined,$("#personal_tabs").tabs()}),$(this).dialog("close")};var c=$(a.data.dom.dialog).dialog({resizable:!1,width:300,modal:!0,title:'<span class="ui-icon ui-icon-alert"></span><span>'+gettext("Warning")+"!</span>",open:function(a,b){$(".confirm-list").html(d())},buttons:b})})},whois_profile:function(a){application.ws.remote("/profiles/"+a.profile_name+"/whois/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main"));var b=$(".whois-map").data();application.maps.connect(),application.maps.center_lonlat(b.lon,b.lat,10)})},edit_profile:function(a){application.ws.remote("/profiles/"+a.profile_name+"/edit/",{},function(b){application.functions.ui.transition(b.data.dom.main,$(".main")),$("#profile-drag-avatar").bind("dragenter",function(a){return!1}).bind("dragstart",function(a){return!1}).bind("dragleave",function(a){return!1}).bind("dragover",function(a){return!1}).bind("drop",function(b){var c=b.originalEvent;c.stopPropagation(),c.preventDefault();var d=c.dataTransfer.files,e=d.length;if(e==1){var f=d[0];$("#profile-drag-avatar-current > span").text("Processing");var g=new FileReader;g.onloadend=function(b){var c=$("#profile-avatar-preview")[0];application.ws.remote("/profiles/"+a.profile_name+"/edit/",{params:{avatar:b.target.result}},function(a){$("#profile-drag-avatar-current > img").length>0?$("#profile-drag-avatar-current > img").attr("src","/media/files/avatars/"+a.data.avatar):($("#profile-drag-avatar-current > div").remove(),$("#profile-drag-avatar-current").append('<img src="/media/files/avatars/'+a.data.avatar+'"/>')),$("#profile-drag-avatar-current > span").text("")})},g.readAsDataURL(f)}})})},cancel_edit_profile:function(){this.manage_profiles()},save_edit_profile:function(a){var b=$("form:visible").serializeObject();application.ws.remote("/profiles/"+a.profile_name+"/edit/",{params:b},function(a){switch(a.status.code){case"FORM_INVALID":application.functions.ui.transition(a.data.dom.main,$(".main"),a.status.code),$.each($(".errorlist"),function(){$(this).next().prepend('<span class="ui-icon ui-icon-info"></span>')});break;case"PROFILE_EDIT_OK":application.functions.ui.transition(a.data.dom.main,$(".main"),a.status.code),$("#personal_tabs").tabs()}})}}}function d(){var a="<ul>";$.each($(":checkbox:checked:visible"),function(b,c){a=a+"<li>"+$(this).parent().next().text()+"</li>"}),a+="</ul>";return a}var a,b,c;return{init:function(c,d){a=$.context({anchor:".main",delegate:"#profiles-context",uri:"/profiles/context/",id:"ctx-profiles"}),e(),f(),g(),b=0,application.functions.profiles.route(c,d);return"profiles"},load:function(c,d){typeof application.cache.load.context.profiles=="undefined"&&(application.cache.load.context.profiles=!0,a.reload()),g(),b=0,application.functions.profiles.route(c,d)},clean_up:function(){h()}}})