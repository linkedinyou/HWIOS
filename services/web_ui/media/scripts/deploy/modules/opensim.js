(function(a){function g(b){var c=0;for(var d=0;d<b.files.length;d++)a.inArray(b.files[d].fileName.substr(-4,4),b.formats)!=-1&&(c+=1);d=0,onload=b.onload,b.total=0,b.sent=0;while(b.current<c)b.total+=b.files[b.current++].fileSize;b.current=0;if(c){for(var d=0;d<b.files.length;d++)if(a.inArray(b.files[d].fileName.substr(-4,4),b.formats)!=-1){b.file=b.files[d],b.current=d;break}f(b).onload=function(d,e){if(++b.current<c){b.sent+=b.files[b.current-1].fileSize;for(var g=b.current;g<b.files.length;g++)if(a.inArray(b.files[g].fileName.substr(-4,4),b.formats)!=-1){b.file=b.files[g],b.current=g;break}f(b).onload=arguments.callee}else onload&&(b.onload=onload,b.onload(d,e))}}else{var e="";for(var d=0;d<b.formats;d++)d!=b.formats.length-1?e+=b.formats[d]+",":e+=b.formats[d];a.jGrowl("Only files with the following extensions are allowed:"+e)}return b}function e(a){var b=0;while(1023<a)a/=1024,++b;return b?a.toFixed(2)+[""," Kb"," Mb"," Gb"," Tb"][b]:a+" bytes"}var b=0,c={},d={init:function(d){var e={url:"",submit:"",cancel:"",select_box:"",formats:[],progress:""};c=a.extend(e,d),this.each(function(){var d=a(this).get(0);a(c.progress).html('<div id="upload-progressbar"></div><div id="upload-status-text"></div>'),a("#upload-progressbar").progressbar({value:0,disabled:!0}),a(this).change(function(){b=0;var d="",e=!1;if(this.files.length>0){for(var f=0;f<this.files.length;f++)a.inArray(this.files[f].fileName.substr(-4,4),c.formats)!=-1&&(b+=this.files[f].fileSize,d+="<p>"+this.files[f].fileName+"</p>",e=!0);if(e)a(c.submit).removeClass("ui-state-disabled");else{a(c.submit).addClass("ui-state-disabled");var g="";for(var f=0;f<c.formats.length;f++)f!=c.formats.length-1?g+=c.formats[f]+",":g+=c.formats[f]}}else a(c.submit).addClass("ui-state-disabled");a(c.select_box).html(d)})})},send:function(d){this.each(function(){var f=a(this).get(0);a(this).attr("disabled","true"),a(c.submit).addClass("ui-state-disabled"),a(c.cancel).addClass("ui-state-disabled");var h=a("#upload-status-text").get(0);g({url:c.url,formats:c.formats,files:f.files,onloadstart:function(){h.innerHTML="Init upload ... "},onprogress:function(c){total_progress=parseInt((this.sent+c.loaded)/b*100),file_progress=parseInt(c.loaded/c.total*100),a("#upload-progressbar").progressbar("option","value",total_progress),h.innerHTML=["Uploading: "+this.file.fileName+" ("+file_progress+"%)","Sent: "+e(this.sent+c.loaded)+" of "+e(b)].join("<br />")},onload:function(a,b){response=JSON.parse(b.responseText),d(response)},onerror:function(){h.innerHTML="The file "+this.file.fileName+" is too big ["+e(this.file.fileSize)+"]",f.removeAttribute("disabled")}})})}};a.fn.xhr_upload=function(b){if(d[b])return d[b].apply(this,Array.prototype.slice.call(arguments,1));if(typeof b!=="object"&&b)a.error("Method "+b+" does not exist on jQuery.xhr_upload");else return d.init.apply(this,arguments)};var f=1024e5;f=function(b,c){var d=function(a){return b.call(a)==="[object Function]"},e="onabort.onerror.onloadstart.onprogress".split("."),f=e.length;return function(b){if(c&&c<b.file.fileSize)d(b.onerror)&&b.onerror();else{var g=new XMLHttpRequest,h=g.upload;for(var g=new XMLHttpRequest,h=g.upload,i=0;i<f;i++)h[e[i]]=function(a){return function(c){d(b[a])&&b[a].call(b,c,g)}}(e[i]);h.onload=function(a){b.onreadystatechange===!1?d(b.onload)&&b.onload(a,g):setTimeout(function(){g.readyState===4?d(b.onload)&&b.onload(a,g):setTimeout(arguments.callee,15)},15)},a.inArray(b.file.fileName.substr(-4,4),b.formats)!=-1&&(g.open("POST",b.url),g.setRequestHeader("If-Modified-Since","Mon, 26 Jul 1997 05:00:00 GMT"),g.setRequestHeader("Cache-Control","no-cache"),g.setRequestHeader("X-Requested-With","XMLHttpRequest"),g.setRequestHeader("X-File-Name",b.file.fileName),g.setRequestHeader("X-File-Size",b.file.fileSize),g.setRequestHeader("Content-Type","application/octet-stream"),g.send(b.file));return b}}}(Object.prototype.toString,f)})(jQuery),define("lib/jquery/jquery.xhr_upload",function(){}),define("modules/opensim",["lib/jquery/jquery.xhr_upload"],function(a,b){function k(){$(document).unbind("MAP_FREE_LOCATION")}function j(){$(document).bind("MAP_FREE_LOCATION",function(a,b,c){$("input").each(function(a){$(this).attr("id")=="id_sim_location_x"?$(this).val(b):$(this).attr("id")=="id_sim_location_y"&&$(this).val(c)})})}function i(){application.ws.method("^/opensim/settings/modified/$",function(a){console.log(a),application.functions.opensim.view_settings(a,!0)}),application.ws.method("^/opensim/avatars/modified/$",function(a){application.functions.opensim.view_avatars(a,!0)}),application.ws.method("^/opensim/regions/modified/$",function(a){application.functions.opensim.view_regions(a,!0)})}function h(){application.functions.opensim={route:function(a,b){c==undefined&&(c=[[XRegExp("^/opensim/settings/$"),this.view_settings],[XRegExp("^/opensim/avatars/$"),this.view_avatars],[XRegExp("^/opensim/maps/$"),this.view_maps],[XRegExp("^/opensim/regions/$"),this.view_regions],[XRegExp("^/opensim/regions/create/$"),this.create_region],[XRegExp("^/opensim/regions/(?<uuid>[^/]+)/edit/$"),this.edit_region],[XRegExp("^/opensim/regions/scenes/upload/$"),this.upload_scenes],[XRegExp("^/opensim/avatars/luggage/upload/$"),this.upload_luggage]]),application.route_uri_to_mod_function(a,c,b)},view_regions:function(a,b){b==undefined?application.ws.remote("/opensim/regions/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),e=$("#region-tabs").tabs(),e.tabs("option","selected",d)}):(application.functions.ui.transition(a.data.dom.main,$(".main")),e=$("#region-tabs").tabs(),e.tabs("option","selected",d))},view_avatars:function(a,b){b==undefined?application.ws.remote("/opensim/avatars/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),e=$("#avatar-tabs").tabs(),e.tabs("option","selected",d)}):(application.functions.ui.transition(a.data.dom.main,$(".main")),e=$("#avatar-tabs").tabs(),e.tabs("option","selected",d))},view_settings:function(a,c){c==undefined?application.ws.remote("/opensim/settings/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),e=$("#settings_tabs").tabs({show:function(a,c){c.index==1&&b.connect()}})}):(application.functions.ui.transition(a.data.dom.main,$(".main")),e=$("#settings_tabs").tabs({show:function(a,c){c.index==1&&b.connect()}}))},view_maps:function(){application.ws.remote("/maps/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),b.connect()})},sync_avatars:function(){application.ws.remote("/data/opensim/avatars/sync/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),e=$("#avatar-tabs").tabs(),$(".main").fadeIn()})},upload_luggage:function(){e!=undefined&&(d=e.tabs("option","selected")),application.ws.remote("/opensim/avatars/luggage/upload/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),$("#id_scene").xhr_upload({url:"/data/opensim/avatars/luggage/upload/",submit:"#upload-start-button",cancel:"#upload-cancel-button",formats:[".iar"],select_box:"#upload-selected",progress:"#upload-status"})})},start_upload_luggage:function(){$("#id_scene").xhr_upload("send",function(a){typeof $("#upload-start-button").val()!=="undefined"&&(application.functions.ui.transition(a.data.dom.main,$(".main")),e=$("#avatar-tabs").tabs(),e.tabs("option","selected",d)),$("#notify-container").notify("create",application.ws.tt[a.status.type],{i18n:a.status.i18n})})},delete_luggage:function(a){d=e.tabs("option","selected"),application.ws.remote("/data/opensim/avatars/luggage/delete/",{},function(a){$deleteLuggage=$(a.data.dom.dialog).dialog({resizable:!1,width:300,modal:!0,title:gettext("Please confirm")+"...",zIndex:1e6,open:function(a,b){$(".confirm-list").html(f())},buttons:{Cancel:function(){$(this).dialog("close")},Delete:function(){var a=$(":checkbox:checked:visible").serializeObject();application.ws.remote("/data/opensim/avatars/luggage/delete/",{params:a},function(a){application.cb_selected=0,application.functions.ui.transition(a.data.dom.main,$(".main")),$deleteLuggage.dialog("destroy"),e=$("#avatar-tabs").tabs(),e.tabs("option","selected",d)})}}})})},load_luggage:function(a){var b=e.tabs("option","selected");application.ws.remote("/data/opensim/avatars/luggage/"+a.name+"/load/",{},function(b){i18nButtons={},i18nButtons[gettext("Cancel")]=function(){$(this).dialog("close")},i18nButtons[gettext("Load")]=function(){var b=$("form:visible").serializeObject();application.ws.remote("/data/opensim/avatars/luggage/"+a.name+"/load/",{params:b},function(a){a.status.code=="FORM_INVALID"?($(".dialog-luggage-load .ui-dialog-content").html(a.dom.dialog),$.each($(".dialog-luggage-load .ui-dialog-content .errorlist"),function(){$(this).next().prepend('<span class="ui-icon ui-icon-info"></span>')})):($chooseLuggageDialog.dialog("destroy"),this.view_avatars())})},$chooseLuggageDialog=$(b.data.dom.dialog).dialog({resizable:!1,width:600,height:550,modal:!0,title:gettext("Load luggage file")+" "+a.name+"...",dialogClass:"dialog-luggage-load",buttons:i18nButtons,zIndex:1e6})})},download_luggage:function(a){window.open("/dav/iar/"+a.name,"Download IAR")},backup_luggage:function(a){application.ws.remote("/data/opensim/avatars/luggage/"+a.uuid+"/backup/",{},function(b){i18nButtons={},i18nButtons[gettext("Cancel")]=function(){$(this).dialog("close")},i18nButtons[gettext("Save")]=function(){var b=$("form:visible").serializeObject();b.profile_uuid=a.uuid,application.ws.remote("/data/opensim/luggage/"+a.uuid+"/backup/",{params:b},function(a){if(a.status.code!="FORM_INVALID"){var b=e.tabs("option","selected");$backupLuggageDialog.dialog("destroy"),application.functions.profiles.view_profiles(a)}else $(".dialog-luggage-backup .ui-dialog-content").html(a.data.dom.dialog),$.each($(".dialog-luggage-backup .ui-dialog-content .errorlist"),function(){$(this).next().prepend('<span class="ui-icon ui-icon-info"></span>')})})},$backupLuggageDialog=$(b.data.dom.dialog).dialog({bgiframe:!0,resizable:!1,width:630,height:550,modal:!0,title:gettext("Save luggage as")+"...",dialogClass:"dialog-luggage-backup",buttons:i18nButtons,zIndex:1e6})})},delete_regions:function(){var a="<ul>";$.each($(":checkbox:checked"),function(b,c){a=a+"<li>"+$(this).parent().next().text()+"</li>"}),a+="</ul>",application.ws.remote("/data/opensim/regions/delete/",{},function(a){i18nButtons={},i18nButtons[gettext("Cancel")]=function(){$(this).dialog("close")},i18nButtons[gettext("Delete")]=function(){var a=$(":checkbox:checked:visible").serializeObject();application.ws.remote("/data/opensim/regions/delete/",{params:a},function(a){b.reset_cache(),application.cb_selected=0,application.functions.ui.transition(a.data.dom.main,$(".main")),e=$("#region-tabs").tabs()}),$(this).dialog("close")},$deleteRegion=$(a.data.dom.dialog).dialog({resizable:!1,width:300,modal:!0,title:'<span class="ui-icon ui-icon-arrow-4-diag"></span><span>'+gettext("Please confirm")+"...</span>",open:function(a,b){$(".confirm-list").html(f())},buttons:i18nButtons,zIndex:1e6})})},create_region:function(a){e!=undefined&&(d=e.tabs("option","selected")),application.ws.remote("/opensim/regions/create/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),b.connect(application)})},cancel_create_region:function(){this.view_regions()},save_create_region:function(){var a=0,c=$("form:visible").serializeObject();application.ws.remote("/opensim/regions/create/",{params:c},function(a){switch(a.status.code){case"FORM_INVALID":$(".main").html(a.data.dom.main),b.connect(application),$.each($("form .errorlist"),function(){$(this).next().prepend('<span class="ui-icon ui-icon-info"></span>')});break;case"REGION_CREATED":b.reset_cache(),application.functions.opensim.view_regions()}})},edit_region:function(a){application.ws.remote("/opensim/regions/"+a.uuid+"/edit/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),b.reset_cache(),b.connect(application),g()})},cancel_edit_region:function(){application.functions.opensim.view_regions()},save_edit_region:function(a){var c=$("form:visible").serializeObject();application.ws.remote("/opensim/regions/"+a.uuid+"/edit/",{params:c},function(a){a.status.code=="REGION_UPDATED"?(b.reset_cache(),application.functions.opensim.view_regions()):($(".regioneditorform").html(a.dom.main),g(),$.each($("form .errorlist"),function(){$(this).next().prepend('<span class="ui-icon ui-icon-info"></span>')}))})},backup_region:function(a){application.ws.remote("/data/opensim/regions/"+a.uuid+"/backup/",{},function(b){i18nButtons={},i18nButtons[gettext("Cancel")]=function(){$(this).dialog("close")},i18nButtons[gettext("Save")]=function(){var b=$("form:visible").serializeObject();application.ws.remote("/data/opensim/regions/"+a.uuid+"/backup/",{params:b},function(a){var b=e.tabs("option","selected");application.cb_selected=0,application.functions.ui.transition(a.data.dom.main,$(".main")),e=$("#region-tabs").tabs(),e.tabs("option","selected",b)}),$(this).dialog("close")},$backupRegion=$(b.data.dom.dialog).dialog({bgiframe:!0,resizable:!1,width:470,height:185,modal:!0,title:gettext("Save scene as")+"...",buttons:i18nButtons,zIndex:1e6})})},delete_scenes:function(){var a=e.tabs("option","selected");application.ws.remote("/data/opensim/regions/scenes/delete/",{},function(b){i18nButtons={},i18nButtons[gettext("Cancel")]=function(){$(this).dialog("close")},i18nButtons[gettext("Delete")]=function(){var b=$(":checkbox:checked:visible").serializeObject();application.ws.remote("/data/opensim/regions/scenes/delete/",{params:b},function(b){application.cb_selected=0,application.functions.ui.transition(b.data.dom.main,$(".main")),e=$("#region-tabs").tabs(),e.tabs("option","selected",a)}),$(this).dialog("close")},$deleteScene=$(b.data.dom.dialog).dialog({resizable:!1,width:380,modal:!0,title:'<span class="ui-icon ui-icon-arrow-4-diag"></span><span>'+gettext("Please confirm")+"...</span>",open:function(a,b){$(".confirm-list").html(f())},buttons:i18nButtons,zIndex:1e6})})},load_scene:function(a){var b=e.tabs("option","selected");application.ws.remote("/data/opensim/regions/scenes/"+a.name+"/load/",{},function(c){i18nButtons={},i18nButtons[gettext("Cancel")]=function(){$(this).dialog("close")},i18nButtons[gettext("Load")]=function(){var c=$("form:visible").serializeObject();application.ws.remote("/data/opensim/regions/scenes/"+a.name+"/load/",{params:c},function(a){application.cb_selected=0,application.functions.ui.transition(a.data.dom.main,$(".main")),e=$("#region-tabs").tabs(),e.tabs("option","selected",b)}),$(this).dialog("close")},$chooseRegionDialog=$(c.data.dom.dialog).dialog({bgiframe:!0,resizable:!1,width:470,modal:!0,title:gettext("Load scene")+" "+a.name+"...",buttons:i18nButtons,zIndex:1e6})})},cancel_scenes_upload:function(){this.view_regions()},upload_scenes:function(){e!=undefined&&(d=e.tabs("option","selected")),application.ws.remote("/opensim/regions/scenes/upload/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),$("#id_scene").xhr_upload({url:"/data/opensim/regions/scenes/upload/",submit:"#upload-start-button",cancel:"#upload-cancel-button",formats:[".oar"],select_box:"#upload-selected",progress:"#upload-status"})})},start_upload_scenes:function(){$("#id_scene").xhr_upload("send",function(a){typeof $("#upload-start-button").val()!=="undefined"&&(application.functions.ui.transition(a.data.dom.main,$(".main")),e=$("#region-tabs").tabs(),e.tabs("option","selected",d)),$("#notify-container").notify("create",application.ws.tt[a.status.type],{i18n:a.status.i18n})})},download_scene:function(a){window.open("/dav/oar/"+a.name,"Download OAR")},update_map_settings:function(){var a=$("form:visible").serializeObject(),c=e.tabs("option","selected");application.ws.remote("/data/settings/maps/update/",{params:a},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),b.connect(application),e=$("#settings_tabs").tabs(),e.tabs("option","selected",c);switch(a.status.code){case"FORM_INVALID":$.each($(".errorlist"),function(){$(this).next().prepend('<span class="ui-icon ui-icon-info"></span>')})}})},render_maps:function(){application.ws.remote("/data/opensim/maps/render/",{},function(a){})},update_settings:function(){var a=$("form:visible").serializeObject(),c=e.tabs("option","selected");application.ws.remote("/opensim/settings/",{params:a},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),e=$("#settings_tabs").tabs({show:function(a,c){c.index==1&&b.connect()}}),e.tabs("option","selected",c);switch(a.status.code){case"SETTINGS_UPDATE_OK":break;case"INVALID_FORM":$(".errorlist").each(function(){$(this).next().prepend('<span class="ui-icon ui-icon-info"></span>')})}})}}}function g(){$("#slider-shutdown-time").slider({animate:!0,min:1,max:60,value:5,change:function(a,b){$("#id_shutdown_time").val($("#slider-shutdown-time").slider("option","value")),$("#slider-shutdown-time-indicator").text(gettext("Reboot")+" ("+$("#slider-shutdown-time").slider("option","value")+" sec.)")}}),$("#id_shutdown_time").val($("#slider-shutdown-time").slider("option","value")),$("#slider-shutdown-time-indicator").text(gettext("Reboot")+" ("+$("#slider-shutdown-time").slider("option","value")+" sec.)")}function f(){var a="<ul>";$.each($(":checkbox:checked:visible"),function(b,c){a=a+"<li>"+$(this).parent().next().text()+"</li>"}),a+="</ul>";return a}var c,d,e;return{init:function(a,b){h(),j(),i(),application.functions.opensim.route(a,b);return"opensim"},load:function(a,b){j(),application.functions.opensim.route(a,b)},clean_up:function(){k()}}})