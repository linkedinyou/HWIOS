require.def("modules/pages",[],function(){function unbind_events(){$(document).unbind("infinote_update"),$("#id_auto_preview").die(),$("#id_type").die()}function bind_events(){function try_run_plasmoid(){try{eval(editor._state.buffer.toString())}catch(error){console.log(error)}}$("#id_type").die().live("change",function(){var a=$(this).val();switch($(this).val()){case"0":editor.change_mode("htmlmixed");break;case"1":editor.change_mode("css");break;case"2":editor.change_mode("javascript")}}),$("#id_auto_preview").live("click",function(){$(this).attr("checked")=="checked"?$("#id_type").val()==1&&(try_run_plasmoid(),$(document).unbind("infinote_update").bind("infinote_update",function(a){delete application.plasmoids[$("#uuid").val()],$(".plasmoid-preview").empty(),try_run_plasmoid()})):($(document).unbind("infinote_update"),delete application.plasmoids[$("#uuid").val()],$(".plasmoid-preview").empty())}),$(document).bind("infinote_synced",function(a,b,c,d){editor===undefined})}function bind_ws(){application.ws.method("^/data/pages/entities/(?<uuid>[^/]+)/online/update/$",function(a){editor.update_online(a.online)}),application.ws.method("^/pages/entities/modified/$",function(a){application.functions.pages.view_pages(a,!0)})}function bind_functions(){application.functions.pages={route:function(a,b){urls==undefined&&(urls=[[XRegExp("^/pages/$"),this.view_pages],[XRegExp("^/pages/anchors/new/$"),this.create_anchor],[XRegExp("^/pages/anchors/(?<uuid>[^/]+)/edit/$"),this.edit_anchor],[XRegExp("^/pages/entities/(?<uuid>[^/]+)/new/$"),this.create_entity],[XRegExp("^/pages/entities/(?<uuid>[^/]+)/edit/$"),this.edit_entity]]),application.route_uri_to_mod_function(a,urls,b)},view_pages:function(a,b){b===undefined?application.ws.remote("/pages/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),apply_tabs()}):(console.log("update"),application.functions.ui.transition(a.data.dom.main,$(".main")),apply_tabs())},create_anchor:function(){application.ws.remote("/pages/anchors/new/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main"))})},save_create_anchor:function(a){var b=$("form:visible").serializeObject();application.ws.remote("/pages/anchors/new/",{form:b},function(a){application.functions.ui.transition(a.data.dom.main,$(".main"),a.status.code),tabs=$("#pages-tabs").tabs()})},edit_anchor:function(a){application.ws.remote("/pages/anchors/"+a.uuid+"/edit/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main"))})},save_edit_anchor:function(a){var b=$("form:visible").serializeObject();application.ws.remote("/pages/anchors/"+a.uuid+"/edit/",{form:b},function(a){application.functions.ui.transition(a.data.dom.main,$(".main"),a.status.code),tabs=$("#pages-tabs").tabs()})},delete_anchors:function(){application.ws.remote("/data/pages/anchors/delete/",{},function(a){i18nButtons={},i18nButtons[gettext("Cancel")]=function(){$(this).dialog("close")},i18nButtons[gettext("Delete")]=function(){var a=$(".datatable :checkbox:checked:visible").serializeObject();application.ws.remote("/data/pages/anchors/delete/",{params:a},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),$tabs=$("#pages-tabs").tabs()}),$(this).dialog("close")},$deletePlasmoid=$(a.data.dom.dialog).dialog({resizable:!1,width:300,modal:!0,title:'<span class="ui-icon ui-icon-arrow-4-diag"></span><span>'+gettext("Please confirm")+"...</span>",open:function(a,b){$(".confirm-list").html(get_cb_names())},buttons:i18nButtons})})},create_entity:function(a){initEditor(a.uuid,undefined,"/pages/entities/"+a.uuid+"/create/")},save_create_entity:function(a){var b=$("form:visible").serializeObject();b.content=editor._state.buffer.toString(),application.ws.remote("/pages/entities/"+a.uuid+"/create/",{form:b},function(b){switch(b.status.code){case"ENTITY_CREATE_OK":application.functions.pages.view_pages(b,!0);break;case"FORM_INVALID":console.log("invalid form!"),initEditor(a.uuid,b)}})},edit_entity:function(a){initEditor(a.uuid,undefined,"/pages/entities/"+a.uuid+"/edit/")},save_edit_entity:function(a){console.log(a);var b=$("form:visible").serializeObject();b.content=editor._state.buffer.toString(),application.ws.remote("/pages/entities/"+a.uuid+"/edit/",{form:b},function(b){switch(b.status.code){case"ENTITY_EDIT_OK":application.functions.pages.view_pages(b,!0);break;case"ENTITY_EDIT_NO_CHANGE":application.functions.pages.view_pages(b,!0);break;case"FORM_INVALID":console.log("invalid form!"),initEditor(a.uuid,b)}})},delete_entities:function(){application.ws.remote("/data/pages/entities/delete/",{},function(a){i18nButtons={},i18nButtons[gettext("Cancel")]=function(){$(this).dialog("close")},i18nButtons[gettext("Delete")]=function(){var a=$(".datatable :checkbox:checked:visible").serializeObject();application.ws.remote("/data/pages/entities/delete/",{params:a},function(a){application.functions.pages.view_pages(a,!0)}),$(this).dialog("close")},$deletePlasmoid=$(a.data.dom.dialog).dialog({resizable:!1,width:300,modal:!0,title:'<span class="ui-icon ui-icon-arrow-4-diag"></span><span>'+gettext("Please confirm")+"...</span>",open:function(a,b){$(".confirm-list").html(get_cb_names())},buttons:i18nButtons})})}}}function apply_tabs(){tabs=$("#pages-tabs").tabs({select:function(a,b){selected_tab=b.index}}),tabs!==undefined&&tabs.tabs("option","selected",selected_tab)}function initEditor(a,b,c){editor=$.jinfinote(application.ws,{ws_connect:c,ws_disconnect:"/data/pages/entities/"+a+"/disconnect/",ws_insert:"/data/pages/entities/"+a+"/insert/",ws_delete:"/data/pages/entities/"+a+"/remove/",ws_undo:"/data/pages/entities/"+a+"/undo/",ws_caret:"/data/pages/entities/"+a+"/caret/",cb_insert:"^/data/pages/entities/(?<uuid>[^/]+)/insert/$",cb_delete:"^/data/pages/entities/(?<uuid>[^/]+)/remove/$",cb_undo:"^/data/pages/entities/(?<uuid>[^/]+)/undo/$",cb_caret:"^/data/pages/entities/(?<uuid>[^/]+)/caret/$",mode:"javascript",init:function(c){b===undefined?application.functions.ui.transition(c.dom.main,$(".main")):(application.functions.ui.transition(b.data.dom.main,$(".main"),b.status.code),$.each($(".main .errorlist"),function(){$(this).next().prepend('<span class="ui-icon ui-icon-info"></span>')}));switch($("#id_type").val()){case"0":$(this)[0].mode="htmlmixed";break;case"1":$(this)[0].mode="css";break;case"2":$(this)[0].mode="javascript"}canvas_preview=$("#entity-"+a).get(0);return{editor_element:"#entity-editor"}}})}function init_helpers(){$("#slider-shutdown-time").slider({animate:!0,min:1,max:60,value:5,change:function(a,b){$("#id_shutdown_time").val($("#slider-shutdown-time").slider("option","value")),$("#slider-shutdown-time-indicator").text(gettext("Reboot")+" ("+$("#slider-shutdown-time").slider("option","value")+" sec.)")}}),$("#id_shutdown_time").val($("#slider-shutdown-time").slider("option","value")),$("#slider-shutdown-time-indicator").text(gettext("Reboot")+" ("+$("#slider-shutdown-time").slider("option","value")+" sec.)")}function get_cb_names(){var a="<ul>";$.each($(".datatable :checkbox:checked:visible"),function(b,c){var d=$(this).parent().next().text();d!=""?a=a+"<li>"+d+"</li>":a=a+"<li>Unnamed - "+$(this).parent().next().next().text()+"</li>"}),a+="</ul>";return a}var editor,plasmoid_uuid,tabs,selected_tab,canvas_preview,processing,urls;return{init:function(a,b){bind_functions(),bind_ws(),bind_events(),application.functions.pages.route(a,b);return"pages"},load:function(a,b){bind_events(),application.functions.pages.route(a,b)},clean_up:function(){unbind_events()}}})