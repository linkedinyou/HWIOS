(function(a){function b(b){rte=this,rte.mh={timer:0,offset:[],size:[],ctrl:!1,element:{}},rte.opts=b,rte.finder=[];var c;rte._state_commands=["bold","italic","underline","strikethrough","subscript","superscript","insertOrderedList","insertUnorderedList","justifyLeft","justifyCenter","justifyRight","fontSize"],rte.editor_container=a(b.editor_element),rte.editor_container.html("\n        <div id='rte-toolbar'>\n        <button type='button' class='rte-icon' id='rte-icon-bold'></button>\n        <button type='button' class='rte-icon' id='rte-icon-italic'></button>\n        <button type='button' class='rte-icon' id='rte-icon-underline'></button>\n        <button type='button' class='rte-icon' id='rte-icon-strikethrough'></button>\n        <button type='button' class='rte-icon rte-button-no-state' id='rte-icon-outdent'></button>\n        <button type='button' class='rte-icon rte-button-no-state' id='rte-icon-indent'></button>\n        <button type='button' class='rte-icon' id='rte-icon-subscript'></button>\n        <button type='button' class='rte-icon' id='rte-icon-superscript'></button>\n        <button type='button' class='rte-icon rte-button-no-state' id='rte-icon-insertHorizontalRule'></button>\n        <button type='button' class='rte-icon' id='rte-icon-insertOrderedList'></button>\n        <button type='button' class='rte-icon' id='rte-icon-insertUnorderedList'></button>\n        <button type='button' class='rte-icon' id='rte-icon-justifyLeft'></button>\n        <button type='button' class='rte-icon' id='rte-icon-justifyCenter'></button>\n        <button type='button' class='rte-icon' id='rte-icon-justifyRight'></button>\n        <button type='button' class='rte-icon rte-button-no-state' id='rte-icon-removeFormat'></button>\n        <button type='button' class='rte-icon rte-selection rte-icon-custom rte-button-no-state rte-icon-inactive' id='rte-icon-createLink'></button>\n        <button type='button' class='rte-icon rte-icon-custom rte-button-no-state' id='rte-icon-insertImage'></button>\n        <select id='rte-value-fontSize'>\n        <option value='select' selected='selected'>Font Size</option>\n        <option value='1'>Smallest</option>\n        <option value='2'>Smaller</option>\n        <option value='3'>Small</option>\n        <option value='4'>Medium</option>\n        <option value='5'>Large</option>\n        <option value='6'>Larger</option>\n        <option value='7'>Largest</option>\n        </select>\n        </div>\n        <div class='rte-contenteditable'></div>");var d=rte.editor_container.attr("id");a(".rte-contenteditable").attr("id",d),a(".rte-contenteditable").bind("paste",function(a){console.log(a)}),rte.editor_container.attr("id",d+"_container"),rte.editor=a(".rte-contenteditable");var e=a("#id_"+d).val();rte.editor.html(e),rte.editor.attr("contenteditable",!0),rte.editor.focus(),rte._bind_handlers()}b.prototype.get_html=function(){return a(rte.editor).html()},b.prototype.set_html=function(b){a(rte.editor).html(b)},b.prototype.focus=function(){a(rte.editor).focus()},b.prototype._bind_handlers=function(){function b(a,b){var c=a.width(),d=a.height();if(b[0]<b[1]){var e=.5*Math.abs(b[1]-d/2);b[1]<d/2?a.width(Math.floor(d-e)):a.width(Math.floor(d+e))}else{var e=.5*Math.abs(b[0]-c/2);b[0]<c/2?a.width(Math.floor(c-e)):a.width(Math.floor(c+e))}}a(".rte-button-no-state").unbind("webkitAnimationEnd").bind("webkitAnimationEnd",function(){this.style.webkitAnimationName=""}),a("#rte-toolbar > button").unbind("click").click(function(){var b=a(this).attr("id").split("-")[2];a(this).hasClass("rte-icon-custom")?a(this).hasClass("rte-icon-inactive")||rte._handle_execCommand(b):(console.log(b),document.execCommand(b,!1,null)),!a(this).hasClass("rte-icon-inactive"),a(this).hasClass("rte-icon-active")&&a(this).removeClass("rte-icon-active"),a(this).hasClass("rte-button-no-state")?a(this).css("webkitAnimationName","push_button"):a(this).addClass("rte-icon-active")}),a("#rte-toolbar > select").unbind("change").change(function(){var b=a(this).attr("id").split("-")[2];document.execCommand(b,!1,a(this).val()),a(this).val("select")}),this.editor.unbind("keydown selectstart mouseup focusout").bind("keydown selectstart mouseup mousedown focusout drag",function(b){b.type=="mouseup"?rte.editor.attr("contenteditable",!0):b.type=="focusout"?rte._query_toolbar_state(b):b.type=="selectstart"?(a("img").trigger("rm-handler"),window.setTimeout(function(){rte._query_toolbar_state(b)},300)):b.type=="mousedown"?b.ctrlKey==!0&&b.preventDefault():b.type!="drag"&&window.setTimeout(function(){rte._query_toolbar_state(b)},0)}),a(".rte-contenteditable").delegate("img","contextmenu",function(a){a.preventDefault(),a.stopPropagation(),rte._show_img_context(a)}),a(".rte-contenteditable").delegate("img","mouseover mouseout mouseup mousedown mousemove",function(c){rte.mh.element=a(this),rte.mh.ctrl?rte.mh.element.hasClass("image-resizable")||rte.mh.element.addClass("image-resizable"):rte.mh.element.hasClass("image-resizable")&&rte.mh.element.removeClass("image-resizable"),c.offsetX!=undefined&&(rte.mh.offset=[c.offsetX,c.offsetY]);var d=[c.target.clientWidth,c.target.clientHeight];c.type=="mouseout"||c.type=="mouseup"?(clearTimeout(rte.mh.timer),rte.mh.ctrl=!1,rte.mh.element.removeClass("image-resizable")):c.type=="mousemove"?(rte.mh.offset=[c.offsetX,c.offsetY],rte.mh.ctrl=c.ctrlKey):c.type=="mousedown"&&(rte.mh.ctrl&&b(rte.mh.element,rte.mh.offset),rte.mh.timer=setTimeout(function(){rte.mh.element.trigger("mousedown",rte.mh.offset)},0))}),document.execCommand("justifyLeft",!1,null)},b.prototype._show_img_context=function(b){if(a(".image-context-menu").length==0){var c='<div class="image-context-menu">\n        <div id="rte-float-left"><span class="ui-icon ui-icon-arrowstop-1-w"></span>Float left</div>\n        <div id="rte-float-right"><span class="ui-icon ui-icon-arrowstop-1-e"></span>Float right</div>\n        <div id="rte-float-clear"><span class="ui-icon ui-icon-arrowstop-1-e"></span>Clear Float</div>\n        </div>';a("body").append(c),a(".image-context-menu").bind("mouseleave click",this._hide_img_context),a(".image-context-menu > div").bind("click",this._select_img_ctx_option)}a(".image-context-menu").css("left",b.clientX-5),a(".image-context-menu").css("top",b.clientY-5),a(".image-context-menu").css("display","block")},b.prototype._hide_img_context=function(b){a(".image-context-menu").css("display","none")},b.prototype._select_img_ctx_option=function(b){switch(b.srcElement.id){case"rte-float-left":a(rte.mh.element).addClass("rte-float-left"),a(rte.mh.element).removeClass("rte-float-right");break;case"rte-float-right":a(rte.mh.element).addClass("rte-float-right"),a(rte.mh.element).removeClass("rte-float-left");break;case"rte-float-clear":a(rte.mh.element).removeClass("rte-float-right"),a(rte.mh.element).removeClass("rte-float-left")}},b.prototype._handle_execCommand=function(b){switch(b){case"createLink":var c="<form>\n                <p><label for='id_url'>Unique Resource Locator</label><input id='id_url' type='text' name='url'/></p>\n                </form>\n            ",d={};d[gettext("Cancel")]=function(){a(this).dialog("destroy"),$register=undefined,console.log("should NOT have selection!!!"),rte._query_toolbar_state()},d[gettext("Insert")]=function(){var b=a("form:visible").serializeObject();a(this).dialog("destroy"),e.addRange(f),document.execCommand("createLink",!1,b.url)};var e=window.getSelection(),f=rte._get_selection(),g=a(c).dialog({autoOpen:!0,position:"center",width:450,title:'<span class="ui-icon ui-icon-person"></span><span>'+gettext("Insert URL")+"</span>",resizable:!1,draggable:!0,modal:!0,buttons:d});break;case"insertImage":a("#rte-finder").remove(),a("body").append(a('<div id="rte-finder"/>')),rte.finder=a("#rte-finder").elfinder({url:"/misc/elconnector/",dialog:{autoOpen:!0,width:950,modal:!0,resizable:!1,title:'<span class="ui-icon ui-icon-document"></span><span>File Manager.</span>',zIndex:400001},editorCallback:function(b){rte._get_focus(),a.each(b,function(a,b){document.execCommand("insertHTML",!0,'<img class="rte-image" src="'+b+'" />')})},closeOnEditorCallback:!0,docked:!1,selectMultiple:!0})}},b.prototype._query_toolbar_state=function(b){a.each(this._state_commands,function(b,c){document.queryCommandState(c)==!0?a("#rte-icon-"+c).addClass("rte-icon-active"):a("#rte-icon-"+c).removeClass("rte-icon-active")});if(b!=undefined){var c=rte._has_selection();c!=undefined&&(b.type!="focusout"&&b.type!="mouseup")?c!=-1?(console.log("REENABLE"),a.each(a(".rte-selection"),function(b,c){a(c).removeClass("rte-icon-inactive")})):(a.each(a(".rte-selection-caret-only"),function(b,c){a(c).removeClass("rte-icon-inactive")}),a.each(a(".rte-selection"),function(b,c){a(c).addClass("rte-icon-inactive")})):(b.type=="mouseup"&&(a.each(a(".rte-selection-caret-only"),function(b,c){a(c).removeClass("rte-icon-inactive")}),a.each(a(".rte-selection"),function(b,c){a(c).addClass("rte-icon-inactive")})),b.type!="focusout")}},b.prototype._inactivate_buttons=function(){a.each(a(".rte-selection"),function(b,c){a(c).addClass("rte-icon-inactive")})},b.prototype._get_selection=function(){var a=window.getSelection();range=a.getRangeAt(0);return range},b.prototype._get_focus=function(){if(last_range!=undefined)var a=last_range;else var a=document.createRange();selection=window.getSelection(),selection.addRange(a)},b.prototype._has_selection=function(){var a=window.getSelection();if(a!=undefined){a.anchorNode!==null&&(last_range=a.getRangeAt(0));return a.anchorNode==a.focusNode?a.anchorOffset!=a.focusOffset?!0:-1:!0}return!1},a.extend({rte_settings:{editor_element:""},rte:function(c,d){opts=a.extend(a.rte_settings,d),opts.editor_element=c,ce=new b(opts);return ce}})})(jQuery),define("lib/jquery/jquery.rte",function(){}),require.def("modules/blog",["lib/jquery/jquery.rte"],function(){function i(){$(".main").undelegate("#blog-content a","click")}function h(){application.ws.method("^/blog/modified/$",function(a){var b=d.get_html();application.functions.blog.view_blog(a,!0),d.set_html(b)}),application.ws.method("^/blog/(?<slug>[^/]+)/modified/$",function(a){a=application.merge_objects(a,$(".blog-article").data()),application.functions.blog.view_article(a,!0)})}function g(){$(".main").delegate("#blog-content a","click",function(a){a.preventDefault(),url=$(a.target).attr("href")+"/",application.functions.blog.route(url,!0)})}function f(){application.functions.blog={route:function(a,b){c==undefined&&(c=[[XRegExp("^/blog/$"),this.view_blog],[XRegExp("^/blog/create/$"),this.view_new_article],[XRegExp("^/blog/(?<id>[^/]+)/$"),this.view_article],[XRegExp("^/blog/(?<id>[^/]+)/edit/$"),this.view_edit_article]]),application.route_uri_to_mod_function(a,c,b)},view_blog:function(a,b){b==undefined?application.ws.remote("/blog/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),$tabs=$("#blog-tabs").tabs({select:function(a,b){history.pushState(null,null,b.tab.hash)}}),d=$.rte("#text",{})}):(application.functions.ui.transition(a.data.dom.main,$(".main")),$tabs=$("#blog-tabs").tabs({select:function(a,b){history.pushState(null,null,b.tab.hash)}}),d=$.rte("#text",{}))},view_article:function(a,b){b==undefined?application.ws.remote("/blog/"+a.id+"/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main"))}):application.functions.ui.transition(a.data.dom.main,$(".main"))},view_new_article:function(a){application.ws.remote("/blog/create/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),d=$.rte("#text",{})})},view_edit_article:function(a){application.ws.remote("/blog/"+a.id+"/edit/",{},function(a){application.functions.ui.transition(a.data.dom.main,$(".main")),d=$.rte("#text",{})})},save_new_article:function(a){var b=application.prepare_form($("form:visible"));application.ws.remote("/blog/create/",{params:b},function(a){application.functions.ui.transition(a.data.dom.main,$(".main"),a.status.code),a.status.code=="FORM_INVALID"&&(d=$.rte("#text",{}),$.each($(".main .errorlist"),function(){$(this).next().prepend('<span class="ui-icon ui-icon-info"></span>')}))})},save_edit_article:function(a){var b=application.prepare_form($("form:visible"));application.ws.remote("/blog/"+a.slug+"/edit/",{params:b},function(a){application.functions.ui.transition(a.data.dom.main,$(".main"),a.status.code),a.status.code=="FORM_INVALID"&&(d=$.rte("#text",{}),$.each($(".main .errorlist"),function(){$(this).next().prepend('<span class="ui-icon ui-icon-info"></span>')}))})},delete_article:function(a){application.ws.remote("/data/blog/"+a.id+"/delete/",{},function(b){i18nButtons={},i18nButtons[gettext("Cancel")]=function(){$(this).dialog("close")},i18nButtons[gettext("Delete")]=function(){application.ws.remote("/data/blog/"+a.id+"/delete/",{params:{uuid:a.uuid}},function(a){switch(a.status.code){case"BLOG_ARTICLE_DELETED":application.functions.ui.transition(a.data.dom.main,$(".main")),$tabs=$("#blog-tabs").tabs({select:function(a,b){window.location.hash=b.tab.hash}}),$.rte(".contenteditable",{})}}),$(this).dialog("close")};var c=$(b.data.dom.dialog).dialog({resizable:!1,width:330,modal:!0,zIndex:1e6,title:'<span class="ui-icon ui-icon-alert"></span><span>'+gettext("Warning")+"!</span>",buttons:i18nButtons})})},create_comment:function(a){var b=application.prepare_form($("form:visible"));application.ws.remote("/data/blog/"+a.slug+"/comments/create/",{params:b},function(a){application.functions.ui.transition(a.data.dom.main,$(".main"));switch(a.status.code){case"BLOG_COMMENT_CREATED":break;case"FORM_INVALID":$.each($(".main .errorlist"),function(){$(this).next().prepend('<span class="ui-icon ui-icon-info"></span>')})}})},delete_comment:function(a){application.ws.remote("/data/blog/"+a.article+"/comments/"+a.uuid+"/delete/",{},function(b){var c=$(b.data.dom.dialog).dialog({resizable:!1,width:440,modal:!0,zIndex:1e6,title:'<span class="ui-icon ui-icon-alert"></span><span>'+gettext("Warning")+"!</span>",buttons:{Cancel:function(){$(this).dialog("close")},Delete:function(){application.ws.remote("/data/blog/"+a.article+"/comments/"+a.uuid+"/delete/",{params:{}},function(a){switch(a.status.code){case"BLOG_COMMENT_DELETED":application.functions.ui.transition(a.data.dom.main,$(".main")),$tabs=$("#blog-tabs").tabs({select:function(a,b){window.location.hash=b.tab.hash}}),$.rte(".contenteditable",{})}}),$(this).dialog("close")}}})})}}}function e(a,b){if(typeof creole_parser=="undefined"){var c={};c.linkFormat="/blog/",creole_parser=new Parse.Simple.Creole(c)}creole_parser.parse(a,b)}var a,b,c,d;return{init:function(b,c){a=$.context({anchor:".main",delegate:"#blog-context",uri:"/blog/context/",id:"ctx-blog"}),application.cache.load.context.blog=!0,f(),h(),application.functions.blog.route(b,c),g();return"blog"},load:function(b,c){typeof application.cache.load.context.blog=="undefined"&&(application.cache.load.context.blog=!0,a.reload()),g(),application.functions.blog.route(b,c)},clean_up:function(){$('div[class*="hwios-plasmoid"]').remove(),i()}}})