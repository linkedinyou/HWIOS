

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>services.web_ui.models.elFinder &mdash; HWIOS v0.6 documentation</title>
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="HWIOS v0.6 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">HWIOS v0.6 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for services.web_ui.models.elFinder</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    services.web_ui.models.elFinder</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    Connector for elFinder File Manager</span>

<span class="sd">    :copyright: Troex Nevelin &lt;troex@fury.scancode.ru&gt;, django patches Dmitry Shapoval &lt;dmitry@0fe.ru&gt;</span>
<span class="sd">    :license: LGPL Version 3 </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">connector</span><span class="p">():</span>
<div class="viewcode-block" id="connector"><a class="viewcode-back" href="../../../../modules/blog.html#services.web_ui.models.elFinder.connector">[docs]</a>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connector for elFinder File Manager</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;root&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
        <span class="s">&#39;URL&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
        <span class="s">&#39;rootAlias&#39;</span><span class="p">:</span> <span class="s">&#39;Home&#39;</span><span class="p">,</span>
        <span class="s">&#39;dotFiles&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="s">&#39;dirSize&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s">&#39;fileMode&#39;</span><span class="p">:</span> <span class="mo">0644</span><span class="p">,</span>
        <span class="s">&#39;dirMode&#39;</span><span class="p">:</span> <span class="mo">0755</span><span class="p">,</span>
        <span class="s">&#39;imgLib&#39;</span><span class="p">:</span> <span class="s">&#39;auto&#39;</span><span class="p">,</span>
        <span class="s">&#39;tmbDir&#39;</span><span class="p">:</span> <span class="s">&#39;.tmb&#39;</span><span class="p">,</span>
        <span class="s">&#39;tmbAtOnce&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s">&#39;tmbSize&#39;</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span>
        <span class="s">&#39;fileURL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s">&#39;uploadMaxSize&#39;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
        <span class="s">&#39;uploadWriteChunk&#39;</span><span class="p">:</span> <span class="mi">8192</span><span class="p">,</span>
        <span class="s">&#39;uploadAllow&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s">&#39;uploadDeny&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s">&#39;uploadOrder&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;deny&#39;</span><span class="p">,</span> <span class="s">&#39;allow&#39;</span><span class="p">],</span>
        <span class="c"># &#39;aclObj&#39;: None, # TODO</span>
        <span class="c"># &#39;aclRole&#39;: &#39;user&#39;, # TODO</span>
        <span class="s">&#39;defaults&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;read&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;write&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;rm&#39;</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">},</span>
        <span class="s">&#39;perms&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s">&#39;archiveMimes&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s">&#39;archivers&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s">&#39;disabled&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s">&#39;debug&#39;</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">}</span>

    <span class="n">_commands</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;open&#39;</span><span class="p">:</span> <span class="s">&#39;__open&#39;</span><span class="p">,</span>
        <span class="s">&#39;reload&#39;</span><span class="p">:</span> <span class="s">&#39;__reload&#39;</span><span class="p">,</span>
        <span class="s">&#39;mkdir&#39;</span><span class="p">:</span> <span class="s">&#39;__mkdir&#39;</span><span class="p">,</span>
        <span class="s">&#39;mkfile&#39;</span><span class="p">:</span> <span class="s">&#39;__mkfile&#39;</span><span class="p">,</span>
        <span class="s">&#39;rename&#39;</span><span class="p">:</span> <span class="s">&#39;__rename&#39;</span><span class="p">,</span>
        <span class="s">&#39;upload&#39;</span><span class="p">:</span> <span class="s">&#39;__upload&#39;</span><span class="p">,</span>
        <span class="s">&#39;paste&#39;</span><span class="p">:</span> <span class="s">&#39;__paste&#39;</span><span class="p">,</span>
        <span class="s">&#39;rm&#39;</span><span class="p">:</span> <span class="s">&#39;__rm&#39;</span><span class="p">,</span>
        <span class="s">&#39;duplicate&#39;</span><span class="p">:</span> <span class="s">&#39;__duplicate&#39;</span><span class="p">,</span>
        <span class="s">&#39;read&#39;</span><span class="p">:</span> <span class="s">&#39;__read&#39;</span><span class="p">,</span>
        <span class="s">&#39;edit&#39;</span><span class="p">:</span> <span class="s">&#39;__edit&#39;</span><span class="p">,</span>
        <span class="s">&#39;extract&#39;</span><span class="p">:</span> <span class="s">&#39;__extract&#39;</span><span class="p">,</span>
        <span class="s">&#39;archive&#39;</span><span class="p">:</span> <span class="s">&#39;__archive&#39;</span><span class="p">,</span>
        <span class="s">&#39;resize&#39;</span><span class="p">:</span> <span class="s">&#39;__resize&#39;</span><span class="p">,</span>
        <span class="s">&#39;tmb&#39;</span><span class="p">:</span> <span class="s">&#39;__thumbnails&#39;</span><span class="p">,</span>
        <span class="s">&#39;ping&#39;</span><span class="p">:</span> <span class="s">&#39;__ping&#39;</span>
    <span class="p">}</span>

    <span class="n">_mimeType</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c"># text</span>
        <span class="s">&#39;txt&#39;</span><span class="p">:</span> <span class="s">&#39;text/plain&#39;</span><span class="p">,</span>
        <span class="s">&#39;conf&#39;</span><span class="p">:</span> <span class="s">&#39;text/plain&#39;</span><span class="p">,</span>
        <span class="s">&#39;ini&#39;</span><span class="p">:</span> <span class="s">&#39;text/plain&#39;</span><span class="p">,</span>
        <span class="s">&#39;php&#39;</span><span class="p">:</span> <span class="s">&#39;text/x-php&#39;</span><span class="p">,</span>
        <span class="s">&#39;html&#39;</span><span class="p">:</span> <span class="s">&#39;text/html&#39;</span><span class="p">,</span>
        <span class="s">&#39;htm&#39;</span><span class="p">:</span> <span class="s">&#39;text/html&#39;</span><span class="p">,</span>
        <span class="s">&#39;js&#39;</span> <span class="p">:</span> <span class="s">&#39;text/javascript&#39;</span><span class="p">,</span>
        <span class="s">&#39;css&#39;</span><span class="p">:</span> <span class="s">&#39;text/css&#39;</span><span class="p">,</span>
        <span class="s">&#39;rtf&#39;</span><span class="p">:</span> <span class="s">&#39;text/rtf&#39;</span><span class="p">,</span>
        <span class="s">&#39;rtfd&#39;</span><span class="p">:</span> <span class="s">&#39;text/rtfd&#39;</span><span class="p">,</span>
        <span class="s">&#39;py&#39;</span> <span class="p">:</span> <span class="s">&#39;text/x-python&#39;</span><span class="p">,</span>
        <span class="s">&#39;java&#39;</span><span class="p">:</span> <span class="s">&#39;text/x-java-source&#39;</span><span class="p">,</span>
        <span class="s">&#39;rb&#39;</span> <span class="p">:</span> <span class="s">&#39;text/x-ruby&#39;</span><span class="p">,</span>
        <span class="s">&#39;sh&#39;</span> <span class="p">:</span> <span class="s">&#39;text/x-shellscript&#39;</span><span class="p">,</span>
        <span class="s">&#39;pl&#39;</span> <span class="p">:</span> <span class="s">&#39;text/x-perl&#39;</span><span class="p">,</span>
        <span class="s">&#39;sql&#39;</span><span class="p">:</span> <span class="s">&#39;text/x-sql&#39;</span><span class="p">,</span>
        <span class="c"># apps</span>
        <span class="s">&#39;doc&#39;</span><span class="p">:</span> <span class="s">&#39;application/msword&#39;</span><span class="p">,</span>
        <span class="s">&#39;ogg&#39;</span><span class="p">:</span> <span class="s">&#39;application/ogg&#39;</span><span class="p">,</span>
        <span class="s">&#39;7z&#39;</span><span class="p">:</span> <span class="s">&#39;application/x-7z-compressed&#39;</span><span class="p">,</span>
        <span class="c"># video</span>
        <span class="s">&#39;ogm&#39;</span><span class="p">:</span> <span class="s">&#39;appllication/ogm&#39;</span><span class="p">,</span>
        <span class="s">&#39;mkv&#39;</span><span class="p">:</span> <span class="s">&#39;video/x-matroska&#39;</span>
    <span class="p">}</span>

    <span class="n">_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_request</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_response</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_errorData</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_form</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_im</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_sp</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_today</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_yesterday</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># public variables</span>
    <span class="n">httpAllowedParameters</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;cmd&#39;</span><span class="p">,</span> <span class="s">&#39;target&#39;</span><span class="p">,</span> <span class="s">&#39;targets[]&#39;</span><span class="p">,</span> <span class="s">&#39;current&#39;</span><span class="p">,</span> <span class="s">&#39;tree&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span>
        <span class="s">&#39;content&#39;</span><span class="p">,</span> <span class="s">&#39;src&#39;</span><span class="p">,</span> <span class="s">&#39;dst&#39;</span><span class="p">,</span> <span class="s">&#39;cut&#39;</span><span class="p">,</span> <span class="s">&#39;init&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="s">&#39;width&#39;</span><span class="p">,</span> <span class="s">&#39;height&#39;</span><span class="p">,</span> <span class="s">&#39;upload[]&#39;</span><span class="p">)</span>
    <span class="c"># return variables</span>
    <span class="n">httpStatusCode</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">httpHeader</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">httpResponse</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;URL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span><span class="p">(</span><span class="s">&#39;URL&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;URL&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span><span class="p">(</span><span class="s">&#39;root&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;disabled&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span><span class="p">[</span><span class="n">cmd</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbDir&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbDir&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbDir&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>


    <span class="k">def</span> <span class="nf">__reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flush per request variables&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">httpStatusCode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">httpResponse</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errorData</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_form</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_today</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_yesterday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_today</span> <span class="o">-</span> <span class="mi">86400</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>


    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">httpRequest</span> <span class="o">=</span> <span class="p">[]):</span>
<div class="viewcode-block" id="connector.run"><a class="viewcode-back" href="../../../../modules/blog.html#services.web_ui.models.elFinder.connector.run">[docs]</a>        <span class="sd">&quot;&quot;&quot;main function&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__reset</span><span class="p">()</span>
        <span class="n">rootOk</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">rootOk</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid backend configuration&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">],</span> <span class="s">&#39;read&#39;</span><span class="p">):</span>
            <span class="n">rootOk</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Access denied&#39;</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">httpAllowedParameters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">httpRequest</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">httpRequest</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">rootOk</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;cmd&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;cmd&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;cmd&#39;</span><span class="p">]]</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">func</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Command Failed&#39;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span><span class="p">(</span><span class="s">&#39;exception&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unknown command&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__open</span><span class="p">()</span>

            <span class="k">if</span> <span class="s">&#39;init&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__checkArchivers</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;disabled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;disabled&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;fileURL&#39;</span><span class="p">]:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;URL&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;dotFiles&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;dotFiles&#39;</span><span class="p">],</span>
                    <span class="s">&#39;uplMaxSize&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;uploadMaxSize&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39;M&#39;</span><span class="p">,</span>
                    <span class="s">&#39;archives&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;archiveMimes&#39;</span><span class="p">],</span>
                    <span class="s">&#39;extract&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;archivers&#39;</span><span class="p">][</span><span class="s">&#39;extract&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                    <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="n">url</span>
                <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errorData</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;errorData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errorData</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;debug&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">httpStatusCode</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpStatusCode</span> <span class="o">=</span> <span class="mi">200</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;Content-type&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&#39;cmd&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;cmd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;upload&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">[</span><span class="s">&#39;Content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;text/html&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">[</span><span class="s">&#39;Content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">httpResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">httpStatusCode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">httpResponse</span>


    <span class="k">def</span> <span class="nf">__open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
        <span class="sd">&quot;&quot;&quot;Open file or directory&quot;&quot;&quot;</span>
        <span class="c"># try to open file</span>
        <span class="k">if</span> <span class="s">&#39;current&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
            <span class="n">curDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">curFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">],</span> <span class="n">curDir</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">curDir</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">curFile</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">curFile</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">httpStatusCode</span> <span class="o">=</span> <span class="mi">404</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">[</span><span class="s">&#39;Content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;text/html&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">httpResponse</span> <span class="o">=</span> <span class="s">&#39;File not found&#39;</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">curFile</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">httpStatusCode</span> <span class="o">=</span> <span class="mi">403</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">[</span><span class="s">&#39;Content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;text/html&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">httpResponse</span> <span class="o">=</span> <span class="s">&#39;Access denied&#39;</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">curFile</span><span class="p">):</span>
                <span class="n">curFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__readlink</span><span class="p">(</span><span class="n">curFile</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">curFile</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">curFile</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">httpStatusCode</span> <span class="o">=</span> <span class="mi">404</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">[</span><span class="s">&#39;Content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;text/html&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">httpResponse</span> <span class="o">=</span> <span class="s">&#39;File not found&#39;</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">curFile</span><span class="p">),</span> <span class="s">&#39;read&#39;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">curFile</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">)</span>
                    <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">httpStatusCode</span> <span class="o">=</span> <span class="mi">403</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">[</span><span class="s">&#39;Content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;text/html&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">httpResponse</span> <span class="o">=</span> <span class="s">&#39;Access denied&#39;</span>
                    <span class="k">return</span>

            <span class="n">mime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mimetype</span><span class="p">(</span><span class="n">curFile</span><span class="p">)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">mime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;image&#39;</span><span class="p">:</span> <span class="n">disp</span> <span class="o">=</span> <span class="s">&#39;image&#39;</span>
            <span class="k">elif</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;text&#39;</span><span class="p">:</span> <span class="n">disp</span> <span class="o">=</span> <span class="s">&#39;inline&#39;</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">disp</span> <span class="o">=</span> <span class="s">&#39;attachments&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">httpStatusCode</span> <span class="o">=</span> <span class="mi">200</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">[</span><span class="s">&#39;Content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">[</span><span class="s">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">disp</span> <span class="o">+</span> <span class="s">&#39;; filename=&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">curFile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">[</span><span class="s">&#39;Content-Location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curFile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">],</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">[</span><span class="s">&#39;Content-Transfer-Encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;binary&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">[</span><span class="s">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">curFile</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">[</span><span class="s">&#39;Connection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;close&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curFile</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c"># try dir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;target&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Access denied&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">target</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;tree&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">)</span>
        <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">__rename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rename file or dir&quot;&quot;&quot;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">name</span> <span class="o">=</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">curDir</span> <span class="o">=</span> <span class="n">curName</span> <span class="o">=</span> <span class="n">newName</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="s">&#39;current&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="s">&#39;target&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">]</span>
            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span>
            <span class="n">curDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">curName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">curDir</span><span class="p">)</span>
            <span class="n">newName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">curDir</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">curName</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;File not found&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">curName</span><span class="p">,</span> <span class="s">&#39;rm&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Access denied&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__checkName</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid name&#39;</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newName</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;File or folder with the same name already exists&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__rmTmb</span><span class="p">(</span><span class="n">curName</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">curName</span><span class="p">,</span> <span class="n">newName</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">newName</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">newName</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unable to rename file&#39;</span>


    <span class="k">def</span> <span class="nf">__mkdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new directory&quot;&quot;&quot;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">newDir</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="s">&#39;current&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">]</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">newDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Access denied&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__checkName</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid name&#39;</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newDir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;File or folder with the same name already exists&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">newDir</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;dirMode&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">newDir</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unable to create folder&#39;</span>


    <span class="k">def</span> <span class="nf">__mkfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new file&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">current</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">curDir</span> <span class="o">=</span> <span class="n">newFile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="s">&#39;current&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">]</span>
            <span class="n">curDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">newFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">curDir</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Access denied&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__checkName</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid name&#39;</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newFile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;File or folder with the same name already exists&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">open</span><span class="p">(</span><span class="n">newFile</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">newFile</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unable to create file&#39;</span>


    <span class="k">def</span> <span class="nf">__rm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete files and directories&quot;&quot;&quot;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">rmList</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">curDir</span> <span class="o">=</span> <span class="n">rmFile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">&#39;current&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="s">&#39;targets[]&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">]</span>
            <span class="n">rmList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;targets[]&#39;</span><span class="p">]</span>
            <span class="n">curDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rmList</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">curDir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rmList</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">rmList</span> <span class="o">=</span> <span class="p">[</span><span class="n">rmList</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">rm</span> <span class="ow">in</span> <span class="n">rmList</span><span class="p">:</span>
            <span class="n">rmFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">curDir</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rmFile</span><span class="p">:</span> <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__remove</span><span class="p">(</span><span class="n">rmFile</span><span class="p">)</span>
        <span class="c"># TODO if errorData not empty return error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__upload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Upload files&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s">&#39;current&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
            <span class="n">curDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">curDir</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Access denied&#39;</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;upload[]&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;No file to upload&#39;</span>
                <span class="k">return</span>

            <span class="n">upFiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;upload[]&#39;</span><span class="p">]</span>
            <span class="c"># invalid format</span>
            <span class="c"># must be list of InMemoryUploadedFile</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">upFiles</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">upSize</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">maxSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;uploadMaxSize&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
            <span class="k">for</span> <span class="n">upFile</span> <span class="ow">in</span> <span class="n">upFiles</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">upFile</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">upFile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__checkName</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;Invalid name&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;uploadWriteChunk&#39;</span><span class="p">])</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">upFile</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="n">upSize</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isUploadAllow</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;fileMode&#39;</span><span class="p">])</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;select&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;Not allowed file type&#39;</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">pass</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;Unable to save uploaded file&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">upSize</span> <span class="o">&gt;</span> <span class="n">maxSize</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;File exceeds the maximum allowed filesize&#39;</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                                <span class="c"># TODO ?</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;File was only partially uploaded&#39;</span><span class="p">)</span>
                            <span class="k">break</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errorData</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errorData</span><span class="p">)</span> <span class="o">==</span> <span class="n">total</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unable to upload files&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Some files was not uploaded&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="k">return</span>


    <span class="k">def</span> <span class="nf">__paste</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy or cut files/directories&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&#39;current&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="s">&#39;src&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="s">&#39;dst&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
            <span class="n">curDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;src&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;dst&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">curDir</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">src</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dst</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s">&#39;targets[]&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
                <span class="k">return</span>
            <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;targets[]&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">files</span><span class="p">]</span>

            <span class="n">cut</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="s">&#39;cut&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;cut&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;1&#39;</span><span class="p">:</span>
                    <span class="n">cut</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Access denied&#39;</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="n">fhash</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find</span><span class="p">(</span><span class="n">fhash</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;File not found&#39;</span>
                    <span class="k">return</span>
                <span class="n">newDst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unable to copy into itself&#39;</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="n">cut</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;rm&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Move failed&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_errorData</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;Access denied&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="c"># TODO thumbs</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newDst</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unable to move files&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_errorData</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;File or folder with the same name already exists&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">newDst</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__rmTmb</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unable to move files&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_errorData</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;Unable to move&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__copy</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">newDst</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unable to copy files&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>

        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">__duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create copy of files/directories&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&#39;current&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="s">&#39;target&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
            <span class="n">curDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">],</span> <span class="n">curDir</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">curDir</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Access denied&#39;</span>
            <span class="n">newName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uniqueName</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__copy</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">newName</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unable to create file copy&#39;</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">__resize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Scale image size&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="s">&#39;current&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="s">&#39;target&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span>
            <span class="ow">and</span> <span class="s">&#39;width&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="s">&#39;height&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span>
            <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
            <span class="k">return</span>

        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;width&#39;</span><span class="p">])</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;height&#39;</span><span class="p">])</span>
        <span class="n">curDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">curFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">],</span> <span class="n">curDir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">curDir</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">curFile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">curFile</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Access denied&#39;</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mimetype</span><span class="p">(</span><span class="n">curFile</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;image&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;File is not an image&#39;</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span><span class="p">(</span><span class="s">&#39;resize &#39;</span> <span class="o">+</span> <span class="n">curFile</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">height</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initImgLib</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">curFile</span><span class="p">)</span>
            <span class="n">imResized</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
            <span class="n">imResized</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">curFile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span><span class="p">(</span><span class="s">&#39;resizeFailed_&#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unable to resize image&#39;</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">curFile</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">__thumbnails</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create previews for images&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&#39;current&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
            <span class="n">curDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">curDir</span> <span class="ow">or</span> <span class="n">curDir</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbDir&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initImgLib</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__canCreateTmb</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbAtOnce&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tmbMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbAtOnce&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmbMax</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">curDir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;images&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">curDir</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">fhash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__canCreateTmb</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">):</span>
                    <span class="n">tmb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbDir&#39;</span><span class="p">],</span> <span class="n">fhash</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmb</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tmb</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">tmb</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;images&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                                <span class="n">fhash</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__path2url</span><span class="p">(</span><span class="n">tmb</span><span class="p">)</span>
                            <span class="p">})</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">tmbMax</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;tmb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">__content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;CWD + CDC + maybe(TREE)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cwd</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cdc</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tree</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;tree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">__cwd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Current Working Directory&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;rootAlias&#39;</span><span class="p">]</span>
            <span class="n">root</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;rootAlias&#39;</span><span class="p">]:</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;rootAlias&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">])</span>

        <span class="n">rel</span> <span class="o">=</span> <span class="n">basename</span> <span class="o">+</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">]):]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;cwd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;hash&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__checkUtf8</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
            <span class="s">&#39;mime&#39;</span><span class="p">:</span> <span class="s">&#39;directory&#39;</span><span class="p">,</span>
            <span class="s">&#39;rel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__checkUtf8</span><span class="p">(</span><span class="n">rel</span><span class="p">),</span>
            <span class="s">&#39;size&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s">&#39;date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> %b %Y %H:%M&quot;</span><span class="p">),</span>
            <span class="s">&#39;read&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;write&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">),</span>
            <span class="s">&#39;rm&#39;</span><span class="p">:</span> <span class="ow">not</span> <span class="n">root</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;rm&#39;</span><span class="p">)</span>
        <span class="p">}</span>


    <span class="k">def</span> <span class="nf">__cdc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Current Directory Content&quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dirs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAccepted</span><span class="p">(</span><span class="n">f</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">pf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__info</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
            <span class="n">info</span><span class="p">[</span><span class="s">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;mime&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;directory&#39;</span><span class="p">:</span>
                <span class="n">dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="n">dirs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;cdc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dirs</span>


    <span class="k">def</span> <span class="nf">__info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">filetype</span> <span class="o">=</span> <span class="s">&#39;file&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">filetype</span> <span class="o">=</span> <span class="s">&#39;file&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">filetype</span> <span class="o">=</span> <span class="s">&#39;dir&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">filetype</span> <span class="o">=</span> <span class="s">&#39;link&#39;</span>

        <span class="n">stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">statDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span>

        <span class="n">fdate</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_today</span><span class="p">:</span>
            <span class="n">fdate</span> <span class="o">=</span> <span class="s">&#39;Today &#39;</span> <span class="o">+</span> <span class="n">statDate</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yesterday</span> <span class="ow">and</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_today</span><span class="p">:</span>
            <span class="n">fdate</span> <span class="o">=</span> <span class="s">&#39;Yesterday &#39;</span> <span class="o">+</span> <span class="n">statDate</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fdate</span> <span class="o">=</span> <span class="n">statDate</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> %b %Y %H:%M&quot;</span><span class="p">)</span>

        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__checkUtf8</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)),</span>
            <span class="s">&#39;hash&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
            <span class="s">&#39;mime&#39;</span><span class="p">:</span> <span class="s">&#39;directory&#39;</span> <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s">&#39;dir&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mimetype</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
            <span class="s">&#39;date&#39;</span><span class="p">:</span> <span class="n">fdate</span><span class="p">,</span>
            <span class="s">&#39;size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dirSize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s">&#39;dir&#39;</span> <span class="k">else</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_size</span><span class="p">,</span>
            <span class="s">&#39;read&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">),</span>
            <span class="s">&#39;write&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">),</span>
            <span class="s">&#39;rm&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;rm&#39;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s">&#39;link&#39;</span><span class="p">:</span>
            <span class="n">lpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__readlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lpath</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="s">&#39;mime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;symlink-broken&#39;</span>
                <span class="k">return</span> <span class="n">info</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">lpath</span><span class="p">):</span>
                <span class="n">info</span><span class="p">[</span><span class="s">&#39;mime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;directory&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="s">&#39;parent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">lpath</span><span class="p">))</span>
                <span class="n">info</span><span class="p">[</span><span class="s">&#39;mime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mimetype</span><span class="p">(</span><span class="n">lpath</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;rootAlias&#39;</span><span class="p">]:</span>
                <span class="n">basename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;rootAlias&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">])</span>

            <span class="n">info</span><span class="p">[</span><span class="s">&#39;link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">lpath</span><span class="p">)</span>
            <span class="n">info</span><span class="p">[</span><span class="s">&#39;linkTo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basename</span> <span class="o">+</span> <span class="n">lpath</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">]):]</span>
            <span class="n">info</span><span class="p">[</span><span class="s">&#39;read&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;read&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">lpath</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">)</span>
            <span class="n">info</span><span class="p">[</span><span class="s">&#39;write&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;write&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">lpath</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">)</span>
            <span class="n">info</span><span class="p">[</span><span class="s">&#39;rm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">lpath</span><span class="p">,</span> <span class="s">&#39;rm&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lpath</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;mime&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;directory&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;fileURL&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;read&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lpath</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__path2url</span><span class="p">(</span><span class="n">lpath</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__path2url</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;mime&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;image&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__canCreateTmb</span><span class="p">():</span>
                    <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getImgSize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dim</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s">&#39;dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim</span>
                        <span class="n">info</span><span class="p">[</span><span class="s">&#39;resize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

                    <span class="c"># if we are in tmb dir, files are thumbs itself</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbDir&#39;</span><span class="p">]:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s">&#39;tmb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__path2url</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">info</span>

                    <span class="n">tmb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbDir&#39;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s">&#39;hash&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmb</span><span class="p">):</span>
                        <span class="n">tmbUrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__path2url</span><span class="p">(</span><span class="n">tmb</span><span class="p">)</span>
                        <span class="n">info</span><span class="p">[</span><span class="s">&#39;tmb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmbUrl</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;tmb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="n">info</span>


    <span class="k">def</span> <span class="nf">__tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return directory tree starting from path&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">return</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">return</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;rootAlias&#39;</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;rootAlias&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;hash&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__checkUtf8</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
            <span class="s">&#39;read&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">),</span>
            <span class="s">&#39;write&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">),</span>
            <span class="s">&#39;dirs&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
                <span class="n">pd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pd</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">pd</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAccepted</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                    <span class="n">tree</span><span class="p">[</span><span class="s">&#39;dirs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tree</span><span class="p">(</span><span class="n">pd</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">tree</span>


    <span class="k">def</span> <span class="nf">__uniqueName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">copy</span> <span class="o">=</span> <span class="s">&#39; copy&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate unique name for file copied file&quot;&quot;&quot;</span>
        <span class="n">curDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">curName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">lastDot</span> <span class="o">=</span> <span class="n">curName</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">newName</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;\..{3}\.(gz|bz|bz2)$&#39;</span><span class="p">,</span> <span class="n">curName</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">7</span>
            <span class="k">if</span> <span class="n">curName</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&#39;2&#39;</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">curName</span><span class="p">[</span><span class="n">pos</span><span class="p">:]</span>
            <span class="n">oldName</span> <span class="o">=</span> <span class="n">curName</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pos</span><span class="p">]</span>
            <span class="n">newName</span> <span class="o">=</span> <span class="n">oldName</span> <span class="o">+</span> <span class="n">copy</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">lastDot</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">oldName</span> <span class="o">=</span> <span class="n">curName</span>
            <span class="n">newName</span> <span class="o">=</span> <span class="n">oldName</span> <span class="o">+</span> <span class="n">copy</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">curName</span><span class="p">[</span><span class="n">lastDot</span><span class="p">:]</span>
            <span class="n">oldName</span> <span class="o">=</span> <span class="n">curName</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lastDot</span><span class="p">]</span>
            <span class="n">newName</span> <span class="o">=</span> <span class="n">oldName</span> <span class="o">+</span> <span class="n">copy</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">oldName</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">copy</span><span class="p">):]</span> <span class="o">==</span> <span class="n">copy</span><span class="p">:</span>
            <span class="n">newName</span> <span class="o">=</span> <span class="n">oldName</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;&#39;</span> <span class="o">+</span> <span class="n">copy</span> <span class="o">+</span><span class="s">&#39;\s\d+$&#39;</span><span class="p">,</span> <span class="n">oldName</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">oldName</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">copy</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">copy</span><span class="p">)</span>
            <span class="n">newName</span> <span class="o">=</span> <span class="n">oldName</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pos</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="n">newName</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newPath</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">newPath</span>

        <span class="c"># if we are here then copy already exists or making copy of copy</span>
        <span class="c"># we will make new indexed copy *black magic*</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">oldName</span><span class="p">[</span><span class="n">pos</span><span class="p">:])</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">newNameExt</span> <span class="o">=</span> <span class="n">newName</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="n">ext</span>
            <span class="n">newPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="n">newNameExt</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newPath</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">newPath</span>
            <span class="c"># if idx &gt;= 1000: break # possible loop</span>

        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">__remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal remove procedure&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">&#39;rm&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">&#39;Access denied&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">&#39;Remove failed&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAccepted</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">&#39;Remove failed&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">__copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal copy procedure&quot;&quot;&quot;</span>
        <span class="n">dstDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s">&#39;Access denied&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">dstDir</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">dstDir</span><span class="p">,</span> <span class="s">&#39;Access denied&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s">&#39;File or folder with the same name already exists&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copymode</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s">&#39;Unable to copy files&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copymode</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s">&#39;Unable to copy files&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
                <span class="n">newSrc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">newDst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__copy</span><span class="p">(</span><span class="n">newSrc</span><span class="p">,</span> <span class="n">newDst</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">newSrc</span><span class="p">,</span> <span class="s">&#39;Unable to copy files&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>


    <span class="k">def</span> <span class="nf">__checkName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for valid file/dir name&quot;&quot;&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="s">r&#39;[\/</span><span class="se">\\</span><span class="s">\:\&lt;\&gt;]&#39;</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>


    <span class="k">def</span> <span class="nf">__findDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fhash</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find directory by hash&quot;&quot;&quot;</span>
        <span class="n">fhash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fhash</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fhash</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">path</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">pd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pd</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">pd</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fhash</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">pd</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">pd</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="n">fhash</span><span class="p">,</span> <span class="n">pd</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ret</span>

        <span class="k">return</span> <span class="bp">None</span>


    <span class="k">def</span> <span class="nf">__find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fhash</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find file/dir by hash&quot;&quot;&quot;</span>
        <span class="n">fhash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fhash</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fhash</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">path</span>
        <span class="k">return</span> <span class="bp">None</span>


    <span class="k">def</span> <span class="nf">__read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;current&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="s">&#39;target&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
            <span class="n">curDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">curFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">],</span> <span class="n">curDir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">curDir</span> <span class="ow">and</span> <span class="n">curFile</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">curFile</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curFile</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Access denied&#39;</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">__edit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save content in file&quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="s">&#39;current&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="s">&#39;target&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">and</span> <span class="s">&#39;content&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
            <span class="n">curDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">curFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">],</span> <span class="n">curDir</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">curFile</span>
            <span class="k">if</span> <span class="n">curFile</span> <span class="ow">and</span> <span class="n">curDir</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">curFile</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">curFile</span><span class="p">,</span> <span class="s">&#39;w+&#39;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">])</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__info</span><span class="p">(</span><span class="n">curFile</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unable to write to file&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Access denied&#39;</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">__archive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compress files/directories to archive&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__checkArchivers</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;archivers&#39;</span><span class="p">][</span><span class="s">&#39;create&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s">&#39;type&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="s">&#39;current&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="s">&#39;targets[]&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span>
            <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
            <span class="k">return</span>

        <span class="n">curDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">archiveType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">archiveType</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;archivers&#39;</span><span class="p">][</span><span class="s">&#39;create&#39;</span><span class="p">]</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">archiveType</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;archiveMimes&#39;</span><span class="p">]</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">curDir</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">)</span>
            <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unable to create archive&#39;</span>
            <span class="k">return</span>

        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;targets[]&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">files</span><span class="p">]</span>

        <span class="n">realFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fhash</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">curFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find</span><span class="p">(</span><span class="n">fhash</span><span class="p">,</span> <span class="n">curDir</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">curFile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;File not found&#39;</span>
                <span class="k">return</span>
            <span class="n">realFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">curFile</span><span class="p">))</span>

        <span class="n">arc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;archivers&#39;</span><span class="p">][</span><span class="s">&#39;create&#39;</span><span class="p">][</span><span class="n">archiveType</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">realFiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">archiveName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">archiveName</span> <span class="o">=</span> <span class="n">realFiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">archiveName</span> <span class="o">+=</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">arc</span><span class="p">[</span><span class="s">&#39;ext&#39;</span><span class="p">]</span>
        <span class="n">archiveName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uniqueName</span><span class="p">(</span><span class="n">archiveName</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">archivePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="n">archiveName</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">arc</span><span class="p">[</span><span class="s">&#39;cmd&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arc</span><span class="p">[</span><span class="s">&#39;argc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">archiveName</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">realFiles</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">curCwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">curDir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__runSubProcess</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">curCwd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archivePath</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">archivePath</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unable to create archive&#39;</span>

        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">__extract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Uncompress archive&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;current&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s">&#39;target&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
            <span class="k">return</span>

        <span class="n">curDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__findDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">curFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">],</span> <span class="n">curDir</span><span class="p">)</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mimetype</span><span class="p">(</span><span class="n">curFile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__checkArchivers</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">mime</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;archivers&#39;</span><span class="p">][</span><span class="s">&#39;extract&#39;</span><span class="p">]</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">curDir</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="n">curFile</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__isAllowed</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">)</span>
            <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Invalid parameters&#39;</span>
            <span class="k">return</span>

        <span class="n">arc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;archivers&#39;</span><span class="p">][</span><span class="s">&#39;extract&#39;</span><span class="p">][</span><span class="n">mime</span><span class="p">]</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">arc</span><span class="p">[</span><span class="s">&#39;cmd&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arc</span><span class="p">[</span><span class="s">&#39;argc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curFile</span><span class="p">)</span>

        <span class="n">curCwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">curDir</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__runSubProcess</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">curCwd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__content</span><span class="p">(</span><span class="n">curDir</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Unable to extract files from archive&#39;</span>

        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">__ping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Workaround for Safari&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">httpStatusCode</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">httpHeader</span><span class="p">[</span><span class="s">&#39;Connection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;close&#39;</span>
        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">__mimetype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Detect mimetype of file&quot;&quot;&quot;</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;unknown&#39;</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">path</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="n">mime</span> <span class="o">==</span> <span class="s">&#39;unknown&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">types_map</span><span class="p">:</span>
            <span class="n">mime</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">types_map</span><span class="p">[</span><span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mime</span> <span class="o">==</span> <span class="s">&#39;text/plain&#39;</span> <span class="ow">and</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&#39;pl&#39;</span><span class="p">:</span>
            <span class="n">mime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mimeType</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mime</span> <span class="o">==</span> <span class="s">&#39;application/vnd.ms-office&#39;</span> <span class="ow">and</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&#39;doc&#39;</span><span class="p">:</span>
            <span class="n">mime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mimeType</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mime</span> <span class="o">==</span> <span class="s">&#39;unknown&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;README&#39;</span><span class="p">,</span> <span class="s">&#39;ChangeLog&#39;</span><span class="p">]:</span>
                <span class="n">mime</span> <span class="o">=</span> <span class="s">&#39;text/plain&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mimeType</span><span class="p">:</span>
                    <span class="n">mime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mimeType</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>

        <span class="c"># self.__debug(&#39;mime &#39; + os.path.basename(path), ext + &#39; &#39; + mime)</span>
        <span class="k">return</span> <span class="n">mime</span>


    <span class="k">def</span> <span class="nf">__tmb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">tmb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal thumbnail create procedure&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>            
            <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbSize&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbSize&#39;</span><span class="p">]</span>
            <span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cropTuple</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">box</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
            <span class="n">im</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
            <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tmb</span><span class="p">,</span> <span class="s">&#39;PNG&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span><span class="p">(</span><span class="s">&#39;tmbFailed_&#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>


    <span class="k">def</span> <span class="nf">__rmTmb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">tmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tmbPath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbDir&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmb</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">tmb</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">__cropTuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">size</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">h</span><span class="p">:</span> <span class="c"># landscape</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">w</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="n">h</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">h</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="n">w</span><span class="p">:</span> <span class="c"># portrait</span>
            <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">u</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">h</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">w</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="n">w</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># cube</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="bp">False</span>


    <span class="k">def</span> <span class="nf">__readlink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read link and return real path if not broken&quot;&quot;&quot;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">target</span>
        <span class="k">return</span> <span class="bp">False</span>


    <span class="k">def</span> <span class="nf">__dirSize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;dirSize&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
                        <span class="n">total_size</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
        <span class="k">return</span> <span class="n">total_size</span>


    <span class="k">def</span> <span class="nf">__fbuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">_options</span><span class="p">[</span><span class="s">&#39;uploadWriteChunk&#39;</span><span class="p">]):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">yield</span> <span class="n">chunk</span>


    <span class="k">def</span> <span class="nf">__canCreateTmb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;imgLib&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbDir&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">mime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mimetype</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;image&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>


    <span class="k">def</span> <span class="nf">__tmbPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">tmb</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbDir&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbDir&#39;</span><span class="p">]:</span>
                <span class="n">tmb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;tmbDir&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hash</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tmb</span>


    <span class="k">def</span> <span class="nf">__isUploadAllow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">allow</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">deny</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">mime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mimetype</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&#39;all&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;uploadAllow&#39;</span><span class="p">]:</span>
            <span class="n">allow</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;uploadAllow&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">mime</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">allow</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="s">&#39;all&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;uploadDeny&#39;</span><span class="p">]:</span>
            <span class="n">deny</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;uploadDeny&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">mime</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">deny</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;uploadOrder&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;allow&#39;</span><span class="p">:</span> <span class="c"># ,deny</span>
            <span class="k">if</span> <span class="n">deny</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">elif</span> <span class="n">allow</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># deny,allow</span>
            <span class="k">if</span> <span class="n">allow</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">deny</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>


    <span class="k">def</span> <span class="nf">__isAccepted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span> <span class="ow">or</span> <span class="n">target</span> <span class="o">==</span> <span class="s">&#39;..&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;dotFiles&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>


    <span class="k">def</span> <span class="nf">__isAllowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">access</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">access</span> <span class="o">==</span> <span class="s">&#39;read&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">access</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="n">access</span> <span class="o">==</span> <span class="s">&#39;write&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">access</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="n">access</span> <span class="o">==</span> <span class="s">&#39;rm&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__errorData</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">access</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">])):]</span>
        <span class="k">for</span> <span class="n">ppath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;perms&#39;</span><span class="p">]:</span>
            <span class="n">regex</span> <span class="o">=</span> <span class="s">r&#39;&#39;</span> <span class="o">+</span> <span class="n">ppath</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">access</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;perms&#39;</span><span class="p">][</span><span class="n">ppath</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;perms&#39;</span><span class="p">][</span><span class="n">ppath</span><span class="p">][</span><span class="n">access</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;defaults&#39;</span><span class="p">][</span><span class="n">access</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">__hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hash of the path&quot;&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>


    <span class="k">def</span> <span class="nf">__path2url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">curDir</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">])</span>
        <span class="n">url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;URL&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">curDir</span><span class="p">[</span><span class="n">length</span><span class="p">:])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">urllib</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">&#39;/:~&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">url</span>


    <span class="k">def</span> <span class="nf">__errorData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Collect error/warning messages&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errorData</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>


    <span class="k">def</span> <span class="nf">__initImgLib</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;imgLib&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_im</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">Image</span>
                <span class="n">Image</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_im</span> <span class="o">=</span> <span class="n">Image</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;imgLib&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;PIL&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;imgLib&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_im</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span><span class="p">(</span><span class="s">&#39;imgLib&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;imgLib&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;imgLib&#39;</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">__getImgSize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initImgLib</span><span class="p">();</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__canCreateTmb</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39;x&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="bp">False</span>


    <span class="k">def</span> <span class="nf">__debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">})</span>
        <span class="k">return</span>


    <span class="k">def</span> <span class="nf">__checkArchivers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># import subprocess</span>
        <span class="c"># sp = subprocess.Popen([&#39;tar&#39;, &#39;--version&#39;], shell = False,</span>
        <span class="c"># stdout = subprocess.PIPE, stderr=subprocess.PIPE)</span>
        <span class="c"># out, err = sp.communicate()</span>
        <span class="c"># print &#39;out:&#39;, out, &#39;\nerr:&#39;, err, &#39;\n&#39;</span>
        <span class="n">archive</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;create&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s">&#39;extract&#39;</span><span class="p">:</span> <span class="p">{}</span> <span class="p">}</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">archive</span><span class="p">[</span><span class="s">&#39;create&#39;</span><span class="p">]</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">archive</span><span class="p">[</span><span class="s">&#39;extract&#39;</span><span class="p">]</span>

        <span class="n">tar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__runSubProcess</span><span class="p">([</span><span class="s">&#39;tar&#39;</span><span class="p">,</span> <span class="s">&#39;--version&#39;</span><span class="p">])</span>
        <span class="n">gzip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__runSubProcess</span><span class="p">([</span><span class="s">&#39;gzip&#39;</span><span class="p">,</span> <span class="s">&#39;--version&#39;</span><span class="p">])</span>
        <span class="n">bzip2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__runSubProcess</span><span class="p">([</span><span class="s">&#39;bzip2&#39;</span><span class="p">,</span> <span class="s">&#39;--version&#39;</span><span class="p">])</span>
        <span class="n">zipc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__runSubProcess</span><span class="p">([</span><span class="s">&#39;zip&#39;</span><span class="p">,</span> <span class="s">&#39;--version&#39;</span><span class="p">])</span>
        <span class="n">unzip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__runSubProcess</span><span class="p">([</span><span class="s">&#39;unzip&#39;</span><span class="p">,</span> <span class="s">&#39;--help&#39;</span><span class="p">])</span>
        <span class="n">rar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__runSubProcess</span><span class="p">([</span><span class="s">&#39;rar&#39;</span><span class="p">,</span> <span class="s">&#39;--version&#39;</span><span class="p">],</span> <span class="n">validReturn</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
        <span class="n">unrar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__runSubProcess</span><span class="p">([</span><span class="s">&#39;unrar&#39;</span><span class="p">],</span> <span class="n">validReturn</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
        <span class="n">p7z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__runSubProcess</span><span class="p">([</span><span class="s">&#39;7z&#39;</span><span class="p">,</span> <span class="s">&#39;--help&#39;</span><span class="p">])</span>
        <span class="n">p7za</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__runSubProcess</span><span class="p">([</span><span class="s">&#39;7za&#39;</span><span class="p">,</span> <span class="s">&#39;--help&#39;</span><span class="p">])</span>
        <span class="n">p7zr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__runSubProcess</span><span class="p">([</span><span class="s">&#39;7zr&#39;</span><span class="p">,</span> <span class="s">&#39;--help&#39;</span><span class="p">])</span>

        <span class="c"># tar = False</span>
        <span class="c"># tar = gzip = bzip2 = zipc = unzip = rar = unrar = False</span>
        <span class="c"># print tar, gzip, bzip2, zipc, unzip, rar, unrar, p7z, p7za, p7zr</span>

        <span class="k">if</span> <span class="n">tar</span><span class="p">:</span>
            <span class="n">mime</span> <span class="o">=</span> <span class="s">&#39;application/x-tar&#39;</span>
            <span class="n">c</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="s">&#39;tar&#39;</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;-cf&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;tar&#39;</span><span class="p">}})</span>
            <span class="n">e</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="s">&#39;tar&#39;</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;-xf&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;tar&#39;</span><span class="p">}})</span>

        <span class="k">if</span> <span class="n">tar</span> <span class="ow">and</span> <span class="n">gzip</span><span class="p">:</span>
            <span class="n">mime</span> <span class="o">=</span> <span class="s">&#39;application/x-gzip&#39;</span>
            <span class="n">c</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="s">&#39;tar&#39;</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;-czf&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;tar.gz&#39;</span><span class="p">}})</span>
            <span class="n">e</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="s">&#39;tar&#39;</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;-xzf&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;tar.gz&#39;</span><span class="p">}})</span>

        <span class="k">if</span> <span class="n">tar</span> <span class="ow">and</span> <span class="n">bzip2</span><span class="p">:</span>
            <span class="n">mime</span> <span class="o">=</span> <span class="s">&#39;application/x-bzip2&#39;</span>
            <span class="n">c</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="s">&#39;tar&#39;</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;-cjf&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;tar.bz2&#39;</span><span class="p">}})</span>
            <span class="n">e</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="s">&#39;tar&#39;</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;-xjf&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;tar.bz2&#39;</span><span class="p">}})</span>

        <span class="n">mime</span> <span class="o">=</span> <span class="s">&#39;application/zip&#39;</span>
        <span class="k">if</span> <span class="n">zipc</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="s">&#39;zip&#39;</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;-r9&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;zip&#39;</span><span class="p">}})</span>
        <span class="k">if</span> <span class="n">unzip</span><span class="p">:</span>
            <span class="n">e</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="s">&#39;unzip&#39;</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;zip&#39;</span><span class="p">}})</span>

        <span class="n">mime</span> <span class="o">=</span> <span class="s">&#39;application/x-rar&#39;</span>
        <span class="k">if</span> <span class="n">rar</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="s">&#39;rar&#39;</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;a -inul&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;rar&#39;</span><span class="p">}})</span>
            <span class="n">e</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="s">&#39;rar&#39;</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;x -y&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;rar&#39;</span><span class="p">}})</span>
        <span class="k">elif</span> <span class="n">unrar</span><span class="p">:</span>
            <span class="n">e</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="s">&#39;unrar&#39;</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;x -y&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;rar&#39;</span><span class="p">}})</span>

        <span class="n">p7zip</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">p7z</span><span class="p">:</span>
            <span class="n">p7zip</span> <span class="o">=</span> <span class="s">&#39;7z&#39;</span>
        <span class="k">elif</span> <span class="n">p7za</span><span class="p">:</span>
            <span class="n">p7zip</span> <span class="o">=</span> <span class="s">&#39;7za&#39;</span>
        <span class="k">elif</span> <span class="n">p7zr</span><span class="p">:</span>
            <span class="n">p7zip</span> <span class="o">=</span> <span class="s">&#39;7zr&#39;</span>

        <span class="k">if</span> <span class="n">p7zip</span><span class="p">:</span>
            <span class="n">mime</span> <span class="o">=</span> <span class="s">&#39;application/x-7z-compressed&#39;</span>
            <span class="n">c</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">p7zip</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;a -t7z&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;7z&#39;</span><span class="p">}})</span>
            <span class="n">e</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">p7zip</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;e -y&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;7z&#39;</span><span class="p">}})</span>

            <span class="n">mime</span> <span class="o">=</span> <span class="s">&#39;application/x-tar&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">p7zip</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;a -ttar&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;tar&#39;</span><span class="p">}})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">p7zip</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;e -y&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;tar&#39;</span><span class="p">}})</span>

            <span class="n">mime</span> <span class="o">=</span> <span class="s">&#39;application/x-gzip&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">p7zip</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;a -tgzip&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;gz&#39;</span><span class="p">}})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">p7zip</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;e -y&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;tar.gz&#39;</span><span class="p">}})</span>

            <span class="n">mime</span> <span class="o">=</span> <span class="s">&#39;application/x-bzip2&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">p7zip</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;a -tbzip2&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;bz2&#39;</span><span class="p">}})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">p7zip</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;e -y&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;tar.bz2&#39;</span><span class="p">}})</span>

            <span class="n">mime</span> <span class="o">=</span> <span class="s">&#39;application/zip&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">p7zip</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;a -tzip&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;zip&#39;</span><span class="p">}})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">mime</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">p7zip</span><span class="p">,</span> <span class="s">&#39;argc&#39;</span><span class="p">:</span> <span class="s">&#39;e -y&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">:</span> <span class="s">&#39;zip&#39;</span><span class="p">}})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;archiveMimes&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;archiveMimes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span><span class="p">[</span><span class="s">&#39;archivers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">archive</span>
        <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">__runSubProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">validReturn</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">subprocess</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sp</span> <span class="o">=</span> <span class="n">subprocess</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sp</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sp</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">returncode</span>
            <span class="c"># print cmd, ret, out, err</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">validReturn</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>


    <span class="k">def</span> <span class="nf">__checkUtf8</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s">&#39;replace&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__debug</span><span class="p">(</span><span class="s">&#39;invalid encoding&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="c">#name += &#39; (invalid encoding)&#39;</span>
        <span class="k">return</span> <span class="n">name</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">HWIOS v0.6 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, OS-Networks.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.8.
    </div>
  </body>
</html>